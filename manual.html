<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-07-03 Mon 17:12 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wire Cell Toolkit Manual</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Brett Viren" />
<meta name="description" content="Documentation for the Wire Cell Toolkit for users, developers and installers."
 />
<meta name="keywords" content="C++, software toolkit, neutrino, liquid argon time projection chamber, LArTPC, drift simulation, field response, event reconstruction, waveform signal processing, 3D imaging, Brookhaven National Lab" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="styles/bigblow/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="styles/bigblow/css/bigblow.css"/>
<link rel="stylesheet" type="text/css" href="styles/bigblow/css/hideshow.css"/>
<script type="text/javascript" src="styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="styles/bigblow/js/bigblow.js"></script>
<script type="text/javascript" src="styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Wire Cell Toolkit Manual</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#news">1. News</a>
<ul>
<li><a href="#org1298c07">1.1. <span class="timestamp-wrapper"><span class="timestamp">[2017-07-03 Mon] </span></span> Porting  and Integration</a></li>
<li><a href="#orgaa0a2ca">1.2. <span class="timestamp-wrapper"><span class="timestamp">[2017-06-23 Fri] </span></span> New Configuration Data Package</a></li>
<li><a href="#org3458161">1.3. <span class="timestamp-wrapper"><span class="timestamp">[2017-06-21 Wed] </span></span> Build cleanups</a></li>
<li><a href="#org0dabeea">1.4. <span class="timestamp-wrapper"><span class="timestamp">[2017-06-20 Tue] </span></span> Exceptions</a></li>
<li><a href="#org008b5a6">1.5. <span class="timestamp-wrapper"><span class="timestamp">[2017-06-17 Sat]  </span></span>  Basic Simulation Essentially Working and CellTree support</a></li>
<li><a href="#org2c3eb53">1.6. <span class="timestamp-wrapper"><span class="timestamp">[2017-06-16 Fri] </span></span> Jsonnet now mandatory and CLI parameter injection</a></li>
</ul>
</li>
<li><a href="#installation">2. Installation</a>
<ul>
<li><a href="#toolkit-installation">2.1. Toolkit installation</a>
<ul>
<li><a href="#source-code">2.1.1. Source code</a></li>
<li><a href="#configuring-the-source">2.1.2. Configuring the source</a></li>
<li><a href="#building-the-source">2.1.3. Building the source</a></li>
<li><a href="#running-unit-tests">2.1.4. Running unit tests</a></li>
<li><a href="#install-built-code">2.1.5. Install the results</a></li>
<li><a href="#other-build-commands">2.1.6. Other build commands</a></li>
</ul>
</li>
<li><a href="#runtime-environment">2.2. Runtime environment</a></li>
<li><a href="#installing-dependencies">2.3. Guide for installation of dependencies</a>
<ul>
<li><a href="#manual-externals-install">2.3.1. Manual</a></li>
<li><a href="#spack-installed-externals">2.3.2. Spack</a></li>
<li><a href="#using-externals-from-ups">2.3.3. UPS</a></li>
</ul>
</li>
<li><a href="#release-management">2.4. Release management</a>
<ul>
<li><a href="#release-versions">2.4.1. Release versions</a></li>
<li><a href="#branch-policy">2.4.2. Branch policy</a></li>
<li><a href="#branch-mechanics">2.4.3. Branch mechanics</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#configuration">3. Configuration</a>
<ul>
<li><a href="#configuration-introduction">3.1. Introduction</a></li>
<li><a href="#user-configuration">3.2. Configuration from a user point of view&#xa0;&#xa0;&#xa0;<span class="tag"><span class="user">user</span></span></a>
<ul>
<li><a href="#configuration-file-formats">3.2.1. File formats</a></li>
<li><a href="#configuration-command-line">3.2.2. Basic command line</a></li>
<li><a href="#dump-default-configuration">3.2.3. Dump default configuration</a></li>
<li><a href="#diving-into-json">3.2.4. Diving into JSON</a></li>
<li><a href="#json-limitations">3.2.5. Limitations of JSON</a></li>
<li><a href="#learning-jsonnet">3.2.6. Learning Jsonnet</a></li>
<li><a href="#configuration-for-specific-detectors">3.2.7. Specific detector support</a></li>
<li><a href="#jsonnet-command-line">3.2.8. Using Jsonnet</a></li>
</ul>
</li>
<li><a href="#developer-configuration">3.3. <span class="todo TODO">TODO</span> Configuration from a developer point of view&#xa0;&#xa0;&#xa0;<span class="tag"><span class="devel">devel</span></span></a></li>
</ul>
</li>
<li><a href="#howtos">4. Howtos</a>
<ul>
<li><a href="#run-wire-cell-cli">4.1. Run <code>wire-cell</code> command line program</a></li>
<li><a href="#add-a-component">4.2. Add a new component class</a>
<ul>
<li><a href="#component-concept">4.2.1. Conceptual design</a></li>
<li><a href="#component-dependencies">4.2.2. Estimating dependencies</a></li>
<li><a href="#component-package">4.2.3. Selecting a package</a></li>
<li><a href="#component-interfaces">4.2.4. Selecting interfaces</a></li>
<li><a href="#component-header">4.2.5. Component header</a></li>
<li><a href="#component-implementation">4.2.6. Component implementation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#internals">5. Internals</a>
<ul>
<li><a href="#toolkit-packages">5.1. Toolkit packages</a>
<ul>
<li><a href="#package-names">5.1.1. Names</a></li>
<li><a href="#package-dependencies">5.1.2. Dependencies</a></li>
<li><a href="#package-structure">5.1.3. Package structure</a></li>
<li><a href="#build-package">5.1.4. Build package</a></li>
<li><a href="#add-new-package-to-build">5.1.5. Adding a new code package</a></li>
</ul>
</li>
<li><a href="#coding-conventions">5.2. Coding conventions</a>
<ul>
<li><a href="#c++-code-formatting">5.2.1. C++ code formatting</a></li>
<li><a href="#c++-namespaces">5.2.2. C++ namespaces</a></li>
<li><a href="#configuration-conventions">5.2.3. Configuration Parameters</a></li>
</ul>
</li>
<li><a href="#interface-internals">5.3. Interfaces</a></li>
<li><a href="#component-internals">5.4. Components</a></li>
<li><a href="#configuration-internals">5.5. Configuration</a></li>
<li><a href="#execution-models">5.6. Execution Models</a>
<ul>
<li><a href="#ad-hoc-execution">5.6.1. Ad-hoc</a></li>
<li><a href="#execution-concrete-components">5.6.2. Concrete</a></li>
<li><a href="#execution-via-interfaces">5.6.3. Interface</a></li>
<li><a href="#dfp-execution">5.6.4. Data flow programming execution</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#packages">6. Packages</a>
<ul>
<li><a href="#pkg-python">6.1. <code>wire-cell-python</code></a>
<ul>
<li><a href="#install-wire-cell-python">6.1.1. Installing <code>wire-cell-python</code></a></li>
<li><a href="#python-programs">6.1.2. Python command line programs</a></li>
<li><a href="#python-modules">6.1.3. <code>wirecell</code> Python modules</a></li>
</ul>
</li>
<li><a href="#pkg-util">6.2. <code>wire-cell-util</code></a>
<ul>
<li><a href="#util-units">6.2.1. Units</a></li>
<li><a href="#util-persistence">6.2.2. Persistence</a></li>
<li><a href="#org7e8da6b">6.2.3. Etc</a></li>
</ul>
</li>
<li><a href="#pkg-iface">6.3. <code>wire-cell-iface</code></a>
<ul>
<li><a href="#org9584164">6.3.1. Data</a></li>
<li><a href="#orgfda9dc7">6.3.2. Nodes</a></li>
<li><a href="#org0320f66">6.3.3. Misc</a></li>
</ul>
</li>
<li><a href="#pkg-gen">6.4. <code>wire-cell-gen</code></a>
<ul>
<li><a href="#org069809f">6.4.1. Depositions</a></li>
<li><a href="#org182aaae">6.4.2. Drifting</a></li>
<li><a href="#orgde2d9b9">6.4.3. Response</a></li>
<li><a href="#org72bafb8">6.4.4. Digitizing</a></li>
<li><a href="#org8b692cd">6.4.5. Noise</a></li>
<li><a href="#org21feb48">6.4.6. Frame Summing</a></li>
<li><a href="#orgcb81342">6.4.7. Execution Graphs</a></li>
</ul>
</li>
<li><a href="#pkg-waftools">6.5. <code>wire-cell-waftools</code></a>
<ul>
<li><a href="#generate-wcb">6.5.1. Recreating <code>wcb</code></a></li>
<li><a href="#bundle-waf-tools">6.5.2. Included Waf tools</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#data-flow-programming">7. Data Flow Programming</a></li>
<li><a href="#other-topics">8. Other Topics</a>
<ul>
<li><a href="#garfield-2d-support">8.1. Garfield 2D Support</a>
<ul>
<li><a href="#garfield-2d-data">8.1.1. Garfield 2D data</a></li>
<li><a href="#preprocessing-garfield-data">8.1.2. Preprocessing of Garfield 2D data</a></li>
<li><a href="#eyeball-garfield">8.1.3. Eyeballing Garfield 2D with <code>wirecell.sigproc.garfield</code></a></li>
<li><a href="#garfield-validation-plots">8.1.4. Validation plots</a></li>
<li><a href="#convert-garfield-data-to-json">8.1.5. Producing WCT Field Response Data File</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-orga09c05e" class="outline-2">
<h2 id="news"><a id="user-content-news" class="anchor" href="#news" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orga09c05e"></a><span class="section-number-2">1</span> News</h2>
<div class="outline-text-2" id="text-news">
<p>
This section lists a reverse timeline of some newsworthy updates and commits to WCT.
</p>
</div>

<div id="outline-container-org1298c07" class="outline-3">
<h3 id="org1298c07"><a id="user-content-org1298c07" class="anchor" href="#org1298c07" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-3">1.1</span> <span class="timestamp-wrapper"><span class="timestamp">[2017-07-03 Mon] </span></span> Porting  and Integration</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Xin concluded an intense effort to port the prototype <a href="https://github.com/WireCell/wire-cell-sigproc">signal processing code into the toolkit</a>.
</p>

<p>
With hints from Lynn Garren (FNAL) a <a href="https://github.com/brettviren/larwirecell/blob/feature/integration/larwirecell/integration.org#set-larwirecell-environment">method</a> to set up an environment where both WCT and its LArSoft integration package (<code>larwirecell</code>) can be simultaneously developed.
</p>
</div>
</div>


<div id="outline-container-orgaa0a2ca" class="outline-3">
<h3 id="orgaa0a2ca"><a id="user-content-orgaa0a2ca" class="anchor" href="#orgaa0a2ca" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-3">1.2</span> <span class="timestamp-wrapper"><span class="timestamp">[2017-06-23 Fri] </span></span> New Configuration Data Package</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Today a new package joins the WCT family.  
</p>

<p>
<a href="https://github.com/WireCell/wire-cell-data">https://github.com/WireCell/wire-cell-data</a>
</p>

<p>
This collects the &ldquo;configuration data&rdquo; files which are needed for
input to WCT.  These are generally compressed JSON files which have
been converted to a WCT standard format from a variety of sources.
The data includes wire geometry, field response, noise spectra and a
couple initial deposition files.  
</p>

<p>
Having this repository makes it easier for users to prepare to run
WCT.  At some point in the future this package may be installed along
with the code, but for now, users need to clone this repo.  For WCT to
locate these files the produced directory needs to be added to the
user&rsquo;s <code>WIRECELL_PATH</code> environment variable.
</p>

<p>
See the <a href="https://github.com/WireCell/wire-cell-data/blob/master/README.org">README</a> file for details including a summary of the files
available and commands to remake these files from their upstream
sources.
</p>

<p>
Previously this data was kept online <a href="http://www.phy.bnl.gov/~bviren/tmp/wctsim/wct-dev/share/wirecell/data/">in a directory</a> dump.  That&rsquo;s
still there for now.  It includes some files not added to GitHub.  In
particular the &ldquo;upstream&rdquo; data from which the JSON files are converted
(eg, the Garfield output) can be found.  And next door to that
directory is a <a href="http://www.phy.bnl.gov/~bviren/tmp/wctsim/wct-dev/share/wirecell/plots/">plot dump directory</a> which contains some diagnostic
plots related to the conversion of these files which may be useful for
experts to browse.
</p>
</div>
</div>


<div id="outline-container-org3458161" class="outline-3">
<h3 id="org3458161"><a id="user-content-org3458161" class="anchor" href="#org3458161" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-3">1.3</span> <span class="timestamp-wrapper"><span class="timestamp">[2017-06-21 Wed] </span></span> Build cleanups</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Today sees some long needed cleanups in how we build WCT and WCP and their externals.  In particular:
</p>

<ul class="org-ul">
<li><a href="http://jsonnet.org/">Jsonnet</a>, now <b>required</b> by WCT has a build package added to <a href="https://github.com/WireCell/wire-cell-spack/blob/master/repo/packages/jsonnet/package.py">wire-cell-spack</a>.</li>
<li>A <a href="http://www.phy.bnl.gov/~bviren/wire-cell-spack-mirror/">source mirror</a> is now available in case you have trouble getting any required dependencies.  The Spack build will use this mirror automatically after being configured as shown in <a href="https://github.com/WireCell/wire-cell-spack/blob/master/README.org#failure-to-download-a-package-source">the README</a> file.</li>
<li>Besides the tip of the <code>master</code> branch, specific releases starting with 0.5.2 of WCT can now be installed with Spack.</li>
<li>The WCP and its dependencies can now be built using wire-cell-spack.  WCP uses a subset of the packages that WCT requires and the two can be installed side-by-side sharing these packages.</li>
<li>See also <a href="https://github.com/WireCell/wire-cell-spack/blob/master/README.org#using-spack-views">this section of the README</a> for recommended way to develop either WCP or WCT code against Spack-built dependencies.</li>
<li>The cursed XData package is removed from both WCP and WCT.</li>
</ul>
</div>
</div>

<div id="outline-container-org0dabeea" class="outline-3">
<h3 id="org0dabeea"><a id="user-content-org0dabeea" class="anchor" href="#org0dabeea" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-3">1.4</span> <span class="timestamp-wrapper"><span class="timestamp">[2017-06-20 Tue] </span></span> Exceptions</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Throwing exceptions is now a SOP for indicating some error.  As you
write configurable components, be particularly liberal with throwing
exceptions inside of the <code>configure()</code> method.  The <code>wire-cell</code> CLI
will catch these and exit.  Other applications of the WCT that do not,
will at least fail early if any exception is thrown and thus the user
can fix the problem without delay.
</p>

<p>
WCT uses Boost exception support hidden with a thin layer to keep
things looking simple.  When you program WCT code with exceptions do
like:
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">"WireCellUtil/Exceptions.h"</span>  

<span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold; text-decoration: underline;">MyComponent</span>::<span style="font-weight: bold;">configure</span>(<span style="font-weight: bold; text-decoration: underline;">Configuration</span> <span style="font-weight: bold; font-style: italic;">cfg</span>)
{
    <span style="font-weight: bold; text-decoration: underline;">std</span>::<span style="font-weight: bold; text-decoration: underline;">string</span> <span style="font-weight: bold; font-style: italic;">mytool_tn</span> = <span style="font-weight: bold; text-decoration: underline;">get</span>&lt;<span style="font-weight: bold; text-decoration: underline;">std</span>::string&gt;(cfg, <span style="font-style: italic;">"mytool"</span>);
    <span style="font-weight: bold;">if</span> (mytool_tn.empty()) {
        THROW(ValueError() &lt;&lt; errmsg{<span style="font-style: italic;">"You must set \"mytool\" to something"</span>});
    }
     m_mytool = <span style="font-weight: bold; text-decoration: underline;">Factory</span>::<span style="font-weight: bold; text-decoration: underline;">find_tn</span>&lt;IMyTool&gt;(<span style="font-weight: bold; font-style: italic;">mytool_tn</span>);
     <span style="font-weight: bold;">if</span> (!m_mytool) {
         THROW(ValueError() &lt;&lt; errmsg{<span style="font-style: italic;">"Failed to find IMyTool: "</span> + mytool_tn});
     }
}
</pre>
</div>

<p>
Notes:
</p>

<ol class="org-ol">
<li>All exceptions that WCT code may throw are defined in the header file included in the example.</li>
<li>Instead of the low-level C++ <code>throw()</code> use the provided CPP macro <code>THROW()</code> which will give the user extra info in the case that an exception is not caught.</li>
<li>The value returned may have an <code>errmsg</code> streamed to it which will add some dynamic description of the error in the form of a string.  If a complex string needs to be build see <code>WireCell::String::format()</code>.</li>
<li>No special C++ is needed to catch exceptions.</li>
</ol>
</div>
</div>


<div id="outline-container-org008b5a6" class="outline-3">
<h3 id="org008b5a6"><a id="user-content-org008b5a6" class="anchor" href="#org008b5a6" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-3">1.5</span> <span class="timestamp-wrapper"><span class="timestamp">[2017-06-17 Sat]  </span></span>  Basic Simulation Essentially Working and CellTree support</h3>
<div class="outline-text-3" id="text-1-5">
<p>
Hanyu Wei has done great job getting the basic drift and response
simulation finished.  In particular it now properly handles the
exceeding fine-scale interpolation that is essential for having
realistically smooth induction signals as a particle&rsquo;s ionization
track moves from the region around one field response path to its
neighbor.  This improvement makes negligible impact on speed.  Also
included is proper drift processes and their statistics as well as the
introduction of an addition RC response for amplifier after the preamp
(for MicroBooNE).  
</p>

<p>
Hanyu also added a <a href="https://github.com/WireCell/wire-cell-sio/blob/master/src/CelltreeFrameSink.cxx">new frame sink</a> to write out &ldquo;celltree&rdquo; file format.
This ROOT-based format has been used for a while now to transfer data
between the Wire-Cell Prototype and other applications.
</p>
</div>
</div>


<div id="outline-container-org2c3eb53" class="outline-3">
<h3 id="org2c3eb53"><a id="user-content-org2c3eb53" class="anchor" href="#org2c3eb53" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-3">1.6</span> <span class="timestamp-wrapper"><span class="timestamp">[2017-06-16 Fri] </span></span> Jsonnet now mandatory and CLI parameter injection</h3>
<div class="outline-text-3" id="text-1-6">
<p>
<a href="https://github.com/google/jsonnet">Jsonnet</a> is now a required external dependency.  It is just far too
useful to keep optional and it&rsquo;s a very light-weight package so easy
to build.  However, it is not yet added to <code>wire-cell-spack</code> (see
<a href="https://github.com/WireCell/wire-cell-spack/issues/1">inaugural issue</a>).  Building it yourself is simple but non-standard.
Follow this guide:
</p>

<ol class="org-ol">
<li>Get the source and do <code>make all</code></li>
<li>Copy the two header under <code>include/</code> at some installation path.</li>
<li>Similarly,   copy the two shared libraries to <code>lib/</code> at some installation path.</li>
<li>Finally, copy the executable binary <code>jsonnet</code> to some <code>bin/</code>.</li>
</ol>

<p>
One annoyance with the elaborate configuration which Jsonnet makes
easy is that, for some things, you do not want to constantly edit a
file just to make some small change.  In particular, initial input and
final output files are often best given directly on the command line
rather than in some configuration file.  Jsonnet also comes to the
rescue here by allowing external parameters to be &ldquo;injected&rdquo; into the
configuration using its <code>std.extVar("name")</code> function.  
</p>

<p>
For this to work, the author of some configuration calls this function
where they would otherwise type in the value.  Then the user must
supply that value on the <code>wire-cell</code> command line or if compiling the
Jsonnet to JSON via the <code>jsonnet</code> CLI.  
</p>

<p>
An example is in the configuration supporting the new &ldquo;multi-ductor&rdquo;
feature (stay tuned for details).  One spot it is used can be found in
<a href="https://github.com/WireCell/wire-cell-cfg/blob/master/multi/depos.jsonnet">depos.jsonnet</a> where the input file holding depositions is set.  The
user of <code>wire-cell</code> or <code>jsonnet</code> sets a value for this variable in the
same way: by simply adding a <code>-V</code> flag.  Here is a full example with
some comments to explain:
</p>

<pre class="example">
$ wire-cell \
   -V detector=uboone \                         # (1)
   -V depofile=g4tuple-qsn-v1-fixed.json.bz2 \  # (2)
   -V framefile=uboone.root \                   # (3)
   -c multi/init.jsonnet \                      # (4) 
   -c multi/multiductor.jsonnet                 # (5)
</pre>

<p>
Notes:
</p>
<ol class="org-ol">
<li>A variable <code>detector</code> is used in various places of the configuration to switch between some global parameters specific to that detector.</li>
<li>The input <code>depofile</code> is set.  Remember that WCT will look for JSON/Jonnet files in directories given in the <code>WIRECELL_PATH</code> environment variable.</li>
<li>The output <code>framefile</code> is set.  This will hold all the frames of traces (aka the &ldquo;event&rdquo;) that get simulated.</li>
<li>The first of two configuration files that being the list of configurables.</li>
<li>The &ldquo;meat&rdquo; of the configuration.</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org50f3a48" class="outline-2">
<h2 id="installation"><a id="user-content-installation" class="anchor" href="#installation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org50f3a48"></a><a id="installation"></a><span class="section-number-2">2</span> Installation</h2>
<div class="outline-text-2" id="text-installation">
<p>
The Wire Cell Toolkit (WCT) should be easy to build on any POSIX&rsquo;y system with a recent C++ compiler.  This section describes how to build releases and development branches, it gives guidance for supplying the few software dependencies, and documents how releases are made.
</p>
</div>

<div id="outline-container-org8e5a2d0" class="outline-3">
<h3 id="toolkit-installation"><a id="user-content-toolkit-installation" class="anchor" href="#toolkit-installation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org8e5a2d0"></a><span class="section-number-3">2.1</span> Toolkit installation</h3>
<div class="outline-text-3" id="text-toolkit-installation">
<div class="warning">
<p>
This assumes you already have available the required dependencies.  See section <a href="#installing-dependencies">2.3</a>.
</p>

</div>

<p>
Installation requires four steps:
</p>
<ol class="org-ol">
<li>get the source</li>
<li>configure the source</li>
<li>build the code</li>
<li>install the results</li>
</ol>
</div>

<div id="outline-container-org0ff120b" class="outline-4">
<h4 id="source-code"><a id="user-content-source-code" class="anchor" href="#source-code" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org0ff120b"></a><span class="section-number-4">2.1.1</span> Source code</h4>
<div class="outline-text-4" id="text-source-code">
<p>
WCT source is composed of several packages (see section <a href="#packages">6</a>) and all source is available from the <a href="https://github.com/WireCell/">Wire Cell GitHub organization</a>.  Releases of each package are made and documented on GitHub (<i>eg</i> <a href="https://github.com/WireCell/wire-cell-build/releases">here</a>) and can be downloaded as archives.  However, using git to assemble a working source area is recommended and easier.  Releases and development branches are handled slightly differently.
</p>

<p>
To obtain a release requires no GitHub authentication:
</p>
<pre class="example">
$ git clone --recursive --branch 0.5.x https://github.com/WireCell/wire-cell-build.git
</pre>
<p>
This gets the tip of the release branch for the <code>0.5.x</code> series.  If a specific release is desired a few more commands are needed.  For example, if the <code>0.5.0</code> release that started the series is wanted:
</p>
<pre class="example">
$ git checkout -b 0.5.0 0.5.0
$ git submodule init
$ git submodule update
$ git submodule foreach git checkout -b 0.5.0 0.5.0
</pre>

<p>
To obtain the development branch requires SSH authentication with GitHub:
</p>
<pre class="example">
$ git clone --recursive git@github.com:WireCell/wire-cell-build.git wct
</pre>

<p>
Which ever way the source is obtained, enter the resulting directory
</p>
<pre class="example">
$ cd wire-cell-build/
</pre>

<div class="tip">
<p>
At some time later if there is a need to switch between HTTP or SSH a <code>switch-git-urls</code> script is available in this directory.
</p>

</div>
</div>
</div>

<div id="outline-container-org125c107" class="outline-4">
<h4 id="configuring-the-source"><a id="user-content-configuring-the-source" class="anchor" href="#configuring-the-source" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org125c107"></a><span class="section-number-4">2.1.2</span> Configuring the source</h4>
<div class="outline-text-4" id="text-configuring-the-source">
<p>
At a minimum, the source must be configured with an installation location for the build results and to allow it to find its dependencies.  This, and the remaining steps are done with the provided <code>wcb</code> script which is an instance of <a href="https://waf.io/">Waf</a>.
</p>
<pre class="example">
$ ./wcb --prefix=/path/to/install configure
</pre>

<p>
This will print the results of the attempts to detect required and optional dependencies.  Missing but optional dependencies will not cause failure.  See below for guidance on installing dependencies if this step fails or if desired optional dependencies are not found.
</p>

<p>
Dependencies are first located in standard system locations, barring that those that are traditionally installed with support for <code>pkg-config</code> may be found by suitably setting the <code>PKG_CONFIG_PATH</code> environment variable.  To force a particular location for any given dependency a <code>--with-*</code> option may be used.
</p>

<div class="note">
<p>
As shown in the example below, the flags to locate Boost are slightly different.
</p>

</div>

<pre class="example">
$ ./wcb configure --prefix=/path/to/install \
   --boost-includes=$WCT_EXTERNALS/include --boost-libs=$WCT_EXTERNALS/lib --boost-mt \
   --with-eigen=$WCT_EXTERNALS --with-jsoncpp=$WCT_EXTERNALS --with-tbb=$WCT_EXTERNALS \
   --with-root=$WCT_EXTERNALS --with-fftw=$WCT_EXTERNALS --with-root=$WCT_EXTERNALS
</pre>
<p>
This example assumes all externals are available in a directory set by the <code>WCT_EXTERNALS</code> variable.  This variable is <b>not</b> used by the build and is only used to make this example brief.
</p>
</div>
</div>

<div id="outline-container-org76607fb" class="outline-4">
<h4 id="building-the-source"><a id="user-content-building-the-source" class="anchor" href="#building-the-source" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org76607fb"></a><span class="section-number-4">2.1.3</span> Building the source</h4>
<div class="outline-text-4" id="text-building-the-source">
<p>
After a successful source configure step, the results are cached and any long command line need not be repeated.  To build the source simply run:
</p>

<pre class="example">
$ ./wcb
</pre>
<p>
If there are build failures more information can be obtained by repeating the build with more verbosity:
</p>
<pre class="example">
$ ./wcb -vv
</pre>
<p>
The build will try to run tests which can be avoided to save time:
</p>
<pre class="example">
$ ./wcb --notests
</pre>
</div>
</div>

<div id="outline-container-orgcbc8d7d" class="outline-4">
<h4 id="running-unit-tests"><a id="user-content-running-unit-tests" class="anchor" href="#running-unit-tests" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgcbc8d7d"></a><span class="section-number-4">2.1.4</span> Running unit tests</h4>
<div class="outline-text-4" id="text-running-unit-tests">
<p>
Unless <code>--notests</code> are passed as above, the build system will build and run the many unit test programs.  In general, all unit tests should run successfully (in practice some small fraction may not).  To give them a chance to succeed they must at least be run with a properly set up environment.  In particular <code>LD_LIBRARY_PATH</code> must contain all library directories for external packages.  Setting this is user/system dependent and so is left to the user.
</p>

<div class="INFO">
<p>
Developers wishing to run unit tests that exercise code they are developing should take care in setting <code>LD_LIBRARY_PATH</code>.  If the WCT installation area is included then the unit tests will run against those libraries, effectively masking the locally built versions in the development area.  Alternatively, they must run <code>./wcb install</code> and then manually re-run the unit test.
</p>

</div>

<p>
Setting <code>LD_LIBRARY_PATH</code> is <b>not</b> as above required for building.  To avoid polluting the build environment with superfluous settings it is possible to create a little shell script that will be used to run each test.  As an example, we create <code>tester.sh</code> that looks like:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/bin/</span><span style="font-weight: bold;">sh</span>
/usr/bin/env <span style="font-weight: bold; font-style: italic;">LD_LIBRARY_PATH</span>=/path/to/extern1/lib:/path/to/extern2/lib <span style="font-style: italic;">"$@"</span>
</pre>
</div>

<p>
After making this script executable it can be used like:
</p>

<pre class="example">
$ ./wcb --testcmd="/path/to/tester.sh %s"
</pre>

<p>
Another useful option is <code>--dump-test-scripts</code> which will produce a <code>test_&lt;name&gt;_run.py</code> file for each <code>test_&lt;name&gt;</code> that bakes in the environment and gives you a per-test runner that you can execute directly.  You can use the same <code>tester.sh</code> script here
</p>

<pre class="example">
$ /path/to/tester.sh ./wcb --dump-test-scripts --alltests
$ ./build/util/test_fft_run.py
</pre>

<p>
Where these two commands are executed in a shell that has no <code>LD_LIBRARY_PATH</code> set.
</p>
</div>
</div>

<div id="outline-container-org068abc7" class="outline-4">
<h4 id="install-built-code"><a id="user-content-install-built-code" class="anchor" href="#install-built-code" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org068abc7"></a><span class="section-number-4">2.1.5</span> Install the results</h4>
<div class="outline-text-4" id="text-install-built-code">
<p>
To install the build results into the location given by <code>--prefix</code> simply issue:
</p>
<pre class="example">
$ ./wcb install
</pre>
</div>
</div>

<div id="outline-container-orgd87c390" class="outline-4">
<h4 id="other-build-commands"><a id="user-content-other-build-commands" class="anchor" href="#other-build-commands" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgd87c390"></a><span class="section-number-4">2.1.6</span> Other build commands</h4>
<div class="outline-text-4" id="text-other-build-commands">
<p>
These other commands may be useful:
</p>

<pre class="example">
$ ./wcb clean          # clean build products
$ ./wcb distclean      # also clean configuration
                       # build with debug symbols  
$ ./wcb configure --build-debug=-ggdb3 [...]
                       # to save some time, just 
                       # rebuild the given test 
                       # and don't run any tests
$ ./wcb --notests --target=test_xxx
$ ./wcb --help         # see more options.
</pre>
</div>
</div>
</div>


<div id="outline-container-org4d77967" class="outline-3">
<h3 id="runtime-environment"><a id="user-content-runtime-environment" class="anchor" href="#runtime-environment" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org4d77967"></a><span class="section-number-3">2.2</span> Runtime environment</h3>
<div class="outline-text-3" id="text-runtime-environment">
<p>
Managing environment is usually a personal choice or computer facility policy and WCT does not place any significant requirements on this.  The usual setting of <code>PATH</code> like variables will likely be needed.  
</p>

<p>
FIXME: we should look into setting <code>RPATH</code>.
</p>

<p>
Internally, WCT does not require any environment however it will search a <code>WIRECELL_PATH</code> when locating configuration or other (non data) input files.  More information is in the section <a href="#configuration">3</a>.
</p>
</div>
</div>

<div id="outline-container-org146c343" class="outline-3">
<h3 id="installing-dependencies"><a id="user-content-installing-dependencies" class="anchor" href="#installing-dependencies" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org146c343"></a><span class="section-number-3">2.3</span> Guide for installation of dependencies</h3>
<div class="outline-text-3" id="text-installing-dependencies">
<p>
The WCT depends on a number of third-party software packages.  They are intentionally limited to reduce the requirements for installation.  Some packages are optional.  Here lists packages that users may not already have as part of a &ldquo;reasonably POSIX&rsquo;y system and some guidance is given on how to install them.
</p>

<p>
The required packages are:
</p>

<dl class="org-dl">
<dt>Boost</dt><dd>various functions</dd>
<dt>Eigen3</dt><dd>matrix representation, interface to FFTW</dd>
<dt>FFTW3</dt><dd>for fast Fast Fourier Transforms</dd>
<dt>JsonCPP</dt><dd>basis for configuration and input data files</dd>
<dt>Jsonnet</dt><dd>structured configuration files.</dd>
<dt>ROOT</dt><dd>for many tests and I/O packages, but not the core library code</dd>
</dl>

<p>
The optional package are:
</p>

<dl class="org-dl">
<dt>Doxygen</dt><dd>for building reference documentation.</dd>
<dt>TBB</dt><dd>for data flow programming paradigm support</dd>
</dl>

<div class="note">
<p>
Some &ldquo;optional&rdquo; packages may actually be currently required for a successful build and test.  This is considered a &ldquo;bug&rdquo; and needs fixing.
</p>

</div>

<p>
This list may not represent current reality.
To get a full, up-to-date list of what packages WCT can use run <code>./wcb --help</code>.   
</p>
</div>

<div id="outline-container-orgf9498d8" class="outline-4">
<h4 id="manual-externals-install"><a id="user-content-manual-externals-install" class="anchor" href="#manual-externals-install" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgf9498d8"></a><span class="section-number-4">2.3.1</span> Manual</h4>
<div class="outline-text-4" id="text-manual-externals-install">
<p>
In the DIY mode, the installer is free to provide the third-party packages in any convenient way.  Many of them are available on well supported operating systems such as Debian/Ubuntu.  Homebrew for Mac OS X is not a core developer platform but may provide many.  Redhat derived Linux distributions may find suitable package on EPEL.  Most of the required packages are fairly easy to build from source.
</p>

<p>
However the installer decides to build in DIY-mode the WCT build system should be able to be given proper installation locations via the <code>--with-*</code> flags as described above.  If it seems not to be the case, please contact the developers.
</p>
</div>
</div>

<div id="outline-container-org46a31f7" class="outline-4">
<h4 id="spack-installed-externals"><a id="user-content-spack-installed-externals" class="anchor" href="#spack-installed-externals" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org46a31f7"></a><span class="section-number-4">2.3.2</span> Spack</h4>
<div class="outline-text-4" id="text-spack-installed-externals">
<p>
<a href="https://github.com/LLNL/spack">Spack</a> is a &ldquo;meta build system&rdquo; that runs the individual build systems that come with packages.  It allows one to manage an ever growing installation area which can accommodate multiple versions of a package.  It also comes with support for <a href="http://modules.sourceforge.net/">Environment Modules</a> to handle your users&rsquo; setup of these packages or can make targeted release &ldquo;views&rdquo; of its package tree.  
</p>

<p>
WCT provides a package <a href="https://github.com/WireCell/wire-cell-spack">wire-cell-spack</a> which collects instructions and an Spack &ldquo;repo&rdquo; that builds WCT and its third-party dependencies.  This leverages Spacks built-in &ldquo;repo&rdquo; to provide dependencies needed by WCT&rsquo;s direct dependencies.  Using it will tend to build packages that one may already have installed through the OS (eg, Python).  However, this duplication should not add much to the overall build time which is automatic nor lead to any problems.
</p>

<p>
An installer that wishes to use wire-cell-spack to provide the dependencies should begin by following its <a href="https://github.com/WireCell/wire-cell-spack/blob/master/README.org">README</a> file.
</p>
</div>
</div>

<div id="outline-container-org3b3dce1" class="outline-4">
<h4 id="using-externals-from-ups"><a id="user-content-using-externals-from-ups" class="anchor" href="#using-externals-from-ups" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org3b3dce1"></a><span class="section-number-4">2.3.3</span> UPS</h4>
<div class="outline-text-4" id="text-using-externals-from-ups">
<p>
Fermi National Accelerator Lab (FNAL) uses a user environment similar but incompatible with to <a href="http://modules.sourceforge.net/">Environment Modules</a>.  It is typical to download binaries provided by FNAL and use UPS to &ldquo;setup&rdquo; a user environment with many environment variables.  For each package so setup there is a variable that gives the installation location.  These can be used to provide suitable values for the <code>--with-*</code> flags to <code>wcb</code> as described above.
</p>
</div>
</div>
</div>


<div id="outline-container-org249f701" class="outline-3">
<h3 id="release-management"><a id="user-content-release-management" class="anchor" href="#release-management" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org249f701"></a><span class="section-number-3">2.4</span> Release management</h3>
<div class="outline-text-3" id="text-release-management">
<p>
Releases are made by developers as needed and as described in this section.
</p>
</div>

<div id="outline-container-orgb85c4e7" class="outline-4">
<h4 id="release-versions"><a id="user-content-release-versions" class="anchor" href="#release-versions" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgb85c4e7"></a><span class="section-number-4">2.4.1</span> Release versions</h4>
<div class="outline-text-4" id="text-release-versions">
<p>
WCT label releases are made following a fixed procedure.  Releases are labeled with  the common three-number convention: <code>X.Y.Z</code>.  These take the following semantic meanings:
</p>

<dl class="org-dl">
<dt>X</dt><dd>a major release is made when developers believe some substantial milestone has been achieved or to being wholly new or a globally breaking development path.</dd>
<dt>Y</dt><dd>a minor or feature release is made when substantial new and in particular any breaking development is made.</dd>
<dt>Z</dt><dd>a bug release fixes problems without otherwise substantial changes.</dd>
</dl>
</div>
</div>

<div id="outline-container-orgda74f57" class="outline-4">
<h4 id="branch-policy"><a id="user-content-branch-policy" class="anchor" href="#branch-policy" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgda74f57"></a><span class="section-number-4">2.4.2</span> Branch policy</h4>
<div class="outline-text-4" id="text-branch-policy">
<p>
Any new major or minor releases produce a new Git branch in each package.  Only bug fixes are made to this branch. Where applicable, release bug fixes should be applied to <code>master</code>.  Nominally, all development is on the <code>master</code> branch however developers are free to make their own feature branches.  They are encourage to do this if their development is expected to be disruptive to other developers.
</p>
</div>
</div>

<div id="outline-container-org29cf909" class="outline-4">
<h4 id="branch-mechanics"><a id="user-content-branch-mechanics" class="anchor" href="#branch-mechanics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org29cf909"></a><span class="section-number-4">2.4.3</span> Branch mechanics</h4>
<div class="outline-text-4" id="text-branch-mechanics">
<p>
To make releases, the above details are baked into two test scripts <a href="https://github.com/WireCell/waf-tools/blob/master/make-release.sh">make-release.sh</a> and <a href="https://github.com/WireCell/waf-tools/blob/master/test-release.sh">test-release.sh</a>.  See comments at the top of each for how to run them.  These scripts can be used by others but are meant for developers to make official releases.  
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org724d85b" class="outline-2">
<h2 id="configuration"><a id="user-content-configuration" class="anchor" href="#configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org724d85b"></a><span class="section-number-2">3</span> Configuration</h2>
<div class="outline-text-2" id="text-configuration">
<p>
As the Wire Cell Toolkit (WCT) is a toolkit, it is up to the parent application to provide some mechanism for the user to provide configuration information to WCT <i>components</i>.  Users of an application not provided by the WCT itself should refer to its documentation.  This section of the manual documents the configuration mechanism that is provided by WCT itself.  If an application decides to use the WCT file format then its users may refer to this document.  Developers of WCT components should read it as well.
</p>
</div>

<div id="outline-container-orga66f6c3" class="outline-3">
<h3 id="configuration-introduction"><a id="user-content-configuration-introduction" class="anchor" href="#configuration-introduction" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orga66f6c3"></a><span class="section-number-3">3.1</span> Introduction</h3>
<div class="outline-text-3" id="text-configuration-introduction">
<p>
WCT itself provides a such a mechanism which is exposed to the user by the <code>wire-cell</code> command line application.  Any application may easily adopt this same mechanism by making use of the <code>WireCell::ConfigManager</code> class.  
</p>

<p>
This WCT configuration mechanism is described here from the point of view of <b>user</b> and <b>developer</b>.  Details for each role are given in the following sections.  However, both user and developer must understand one aspect of WCT internal design in order to understand configuration.  One aspect of WCT is that an application is composed of a number of <i>component</i> classes.  Components work together in some way to enact the job of the application.  A component is specifically a C++ class which implements one or more <i>interface</i> base classes.  One interface pertinent here is <code>IConfigurable</code>.  A component that implements this interface is called a <i>configurable component</i> or just <i>configurable</i>.  A configurable then is the atomic unit of WCT configuration and this unit is reflected in what the user provides for configuration and what developers should expect if they write configurable components.
</p>

<p>
The user then provides an ordered list of <i>configuration objects</i> or simply <i>configurations</i>.  Each configuration is associated by WCT with exactly one  <i>instance</i> of a configurable component class.  This association is done via two string identifiers.  The pair are also used to initially construct and later locate the instance of any type of WCT component (not just configurables):
</p>

<dl class="org-dl">
<dt>type</dt><dd>specifies the &ldquo;configurable type&rdquo; which often matches the C++ class name with any C++ namespace removed.  However, developers of configurable components are free to chose any unique type name.</dd>

<dt>name</dt><dd>specifies a &ldquo;configurable instance&rdquo;, that is an C++ object instance of the C++ class associated with the configurable type identifier.  The name is free form and may be omitted in which case it defaults to the empty string.  A specific name is needed if multiple instances are required or if multiple configurables require sharing a component.</dd>
</dl>

<p>
Finally, configurations have a third attribute:
</p>

<dl class="org-dl">
<dt>data</dt><dd>specifies a data structure following a schema specific to the configurable type.  This is the &ldquo;payload&rdquo; that WCT gives to the instance of the configurable component.</dd>
</dl>

<p>
In the next section,  WCT user-configuration support is described.  The following section gives guidance to developers who wish to write their own configurable components.
</p>
</div>
</div>

<div id="outline-container-org1552050" class="outline-3">
<h3 id="user-configuration"><a id="user-content-user-configuration" class="anchor" href="#user-configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org1552050"></a><span class="section-number-3">3.2</span> Configuration from a user point of view&#xa0;&#xa0;&#xa0;<span class="tag"><span class="user">user</span></span></h3>
<div class="outline-text-3" id="text-user-configuration">
<p>
Users of the WCT command line interface <code>wire-cell</code> or any WCT application that uses <code>WireCell::ConfigManager</code> can provide configuration information in the form of one or more files.  This files express the same ordered list of configuration objects as described above.
</p>
</div>

<div id="outline-container-org22040c8" class="outline-4">
<h4 id="configuration-file-formats"><a id="user-content-configuration-file-formats" class="anchor" href="#configuration-file-formats" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org22040c8"></a><span class="section-number-4">3.2.1</span> File formats</h4>
<div class="outline-text-4" id="text-configuration-file-formats">
<p>
WCT supports two related configuration file formats:  <a href="http://www.json.org/">JSON</a> and <a href="http://jsonnet.org/">Jsonnet</a>.  Of the two, JSON is more fundamental while Jsonnet provides a way to better organize and construct complex configurations.  Jsonnet support is a compile-time option.  The stand-alone <code>jsonnet</code> program may also be used to evaluate Jsonnet into JSON.
</p>
</div>
</div>

<div id="outline-container-org55b544b" class="outline-4">
<h4 id="configuration-command-line"><a id="user-content-configuration-command-line" class="anchor" href="#configuration-command-line" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org55b544b"></a><span class="section-number-4">3.2.2</span> Basic command line</h4>
<div class="outline-text-4" id="text-configuration-command-line">
<p>
A user gives one or more configuration files to the <code>wire-cell</code> application each with a <code>-c</code> flag:
</p>
<pre class="example">
$ wire-cell -c myparameters.cfg [...]
</pre>
<p>
If a relative path is given, the file will be searched for starting in the current working directory and then in each directory listed in a <code>WIRECELL_PATH</code> environment variable, if given.  When multiple configuration are used, their top-level arrays are conceptually concatenated in the order on which they are given on the command line.
</p>
</div>
</div>

<div id="outline-container-org7c8e6b5" class="outline-4">
<h4 id="dump-default-configuration"><a id="user-content-dump-default-configuration" class="anchor" href="#dump-default-configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org7c8e6b5"></a><span class="section-number-4">3.2.3</span> Dump default configuration</h4>
<div class="outline-text-4" id="text-dump-default-configuration">
<div class="warning">
<p>
This dumping functionality is removed from the <code>wire-cell</code> CLI for now.
</p>

</div>

<p>
The user can also dump out the hard-coded default configuration for one or more components:
</p>
<pre class="example">
$ wire-cell \
    -p &lt;plugin&gt; \
    -D &lt;component1&gt; \
    -D &lt;component2&gt; \
    --dump-file=mydefaults.cfg
</pre>
<p>
Here the components to dump are specified by their &ldquo;type&rdquo; identifier as described above.  The  <i>plugins</i> which provide the components must be specified. A plugin typically takes the name of its shared library with the <code>lib</code> prefix and <code>.so</code> extension removed.  
</p>

<p>
The user must know what components to dump.  There is no way for the application to iterate over all possible components.  In general, it is up to the provider of a plugin to catalog what component types it provides.  WCT provides a <a href="https://github.com/WireCell/wire-cell-cfg/blob/master/scripts/generate-defaults.sh">simple script</a> that will search the WCT source, determine the components and dump them out using <code>wire-cell</code>.  Result of this dump, possibly out of date, is available in the <a href="https://github.com/WireCell/wire-cell-cfg/tree/master/defaults">wire-cell-cfg</a> repository.
</p>
</div>
</div>

<div id="outline-container-org48f1baf" class="outline-4">
<h4 id="diving-into-json"><a id="user-content-diving-into-json" class="anchor" href="#diving-into-json" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org48f1baf"></a><span class="section-number-4">3.2.4</span> Diving into JSON</h4>
<div class="outline-text-4" id="text-diving-into-json">
<div class="warning">
<p>
This dumping functionality is removed from the <code>wire-cell</code> CLI for now.
</p>

</div>

<p>
An example configuration dump from this command
</p>
<pre class="example">
$ wire-cell -D TrackDepos -p WireCellGen
</pre>
<p>
produces:
</p>
<div class="org-src-container">
<pre class="src src-js">[
   {
      <span style="font-style: italic;">"data"</span> : {
         <span style="font-style: italic;">"clight"</span> : 1,
         <span style="font-style: italic;">"step_size"</span> : 0.10000000000000001,
         <span style="font-style: italic;">"tracks"</span> : []
      },
      <span style="font-style: italic;">"name"</span> : <span style="font-style: italic;">""</span>,
      <span style="font-style: italic;">"type"</span> : <span style="font-style: italic;">"TrackDepos"</span>
   }
]
</pre>
</div>
<p>
Here we see an array holding one element which is an object with the <code>type</code>, (instance) <code>name</code> and payload <code>data</code> structure as described above.  If <code>wire-cell</code> were to load this configuration it would create a default instance of the component type <code>TrackDepos</code> which happens to correspond to the C++ class <code>WireCell::Gen::TrackDepos</code> (see the <a href="./gen.html">simulation package manual</a> for more information).  This component is responsible for produces deposition (<code>IDepo</code>) objects using a simple linear source model.  
</p>

<p>
The <code>tracks</code> array in this example is empty and no depositions would be produced.  The user most certainly should specify a nonempty set of tracks.  In principle, the user may produces a huge <code>tracks</code> array.  WCT support bzip2 compressed JSON files (see the section on <a href="./util.html#org698a30b">persistence in the util package manual</a>).
</p>
</div>
</div>

<div id="outline-container-org566914a" class="outline-4">
<h4 id="json-limitations"><a id="user-content-json-limitations" class="anchor" href="#json-limitations" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org566914a"></a><span class="section-number-4">3.2.5</span> Limitations of JSON</h4>
<div class="outline-text-4" id="text-json-limitations">
<p>
As the complexity of a <code>wire-cell</code> job grows, hand crafting JSON becomes tedious and error prone.  Splitting the files and/or using <code>WIRECELL_PATH</code> can provide some rudimentary means of organizing a large, complex configuration.  
</p>

<p>
However, a user will quickly outgrow direct authoring of JSON files.  An accomplished user will likely turn to some form of JSON generation using a more expressive language maybe by developing some scripts.  Or, some part of a configuration may need to be extracted or converted from another source.  For example, Geant4 steps might be extracted and formatted into a <code>TrackDepos</code> configuration as a long <code>tracks</code> array.
</p>

<p>
Another limitation is that any numerical quantities <b>must</b> be expressed in the base units used by the WCT <i>system of units</i> (see the section on <a href="./util.html#orgc6f623b">units in the Utilities manual</a>).  This places a burden on the configuration author and is a source of error.
</p>

<p>
The user is free to generate JSON in any manner they wish as long as the result conforms to the required schema.
However, WCT provides a second, more powerful JSON-like configuration file format which described next.
</p>
</div>
</div>

<div id="outline-container-orga9f3094" class="outline-4">
<h4 id="learning-jsonnet"><a id="user-content-learning-jsonnet" class="anchor" href="#learning-jsonnet" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orga9f3094"></a><span class="section-number-4">3.2.6</span> Learning Jsonnet</h4>
<div class="outline-text-4" id="text-learning-jsonnet">
<p>
WCT provides support for configuration files following the <a href="http://jsonnet.org/">Jsonnet data templating language</a>.  This language is evaluated to produce JSON.  If WCT is compiled with support it can evaluation Jsonnet files directly.  Otherwise the user may install and run the <code>jsonnet</code> command line program to produce JSON for feeding to WCT.
</p>

<p>
To learn how to write Jsonnet in general, the user should refer to its documentation which is excellent.  There is no one right way to write Jsonnet, however, the <a href="https://github.com/wirecell/wire-cell-cfg">wire-cell-cfg</a> package provides a number of examples and support files that can help the user craft their configuration in Jsonnet.  In particular the WCT system of units and some common data structures used by WCT are exported to Jsonnet in <a href="https://github.com/WireCell/wire-cell-cfg/blob/master/wirecell.jsonnet">wirecell.jsonnet</a>.  Some of this exported functionality is illustrated below.  
</p>

<p>
WCT locates Jsonnet files as it does JSON files and in particular using the environment variable <code>WIRECELL_PATH</code>.  However, it does not (currently) support compressed Jsonnet files.
</p>
</div>

<div id="outline-container-org14ed826" class="outline-5">
<h5 id="system-of-units-in-jsonnet"><a id="user-content-system-of-units-in-jsonnet" class="anchor" href="#system-of-units-in-jsonnet" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org14ed826"></a><span class="section-number-5">3.2.6.1</span> System of units</h5>
<div class="outline-text-5" id="text-system-of-units-in-jsonnet">
<p>
Wire Cell provides an internal system of units as described in the section on <a href="./util.html#orgc6f623b">units in the Utilities manual</a> and as stated above, users must take care to give numerical quantities in WCT units when providing JSON.  However, when writing Jsonnet one can provide explicit units which is easy and far less error prone.  For example:
</p>
<div class="org-src-container">
<pre class="src src-js">local wc = <span style="font-weight: bold;">import</span> <span style="font-style: italic;">"wirecell.jsonnet"</span>;
[
    {
    type:<span style="font-style: italic;">"TrackDepos"</span>,
    data: {
        step_size: 1.0 * wc.millimeter,
        <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">or could abreviate with wc.mm</span>
        }
    }
]
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdfe0368" class="outline-5">
<h5 id="jsonnet-helper-functions"><a id="user-content-jsonnet-helper-functions" class="anchor" href="#jsonnet-helper-functions" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgdfe0368"></a><span class="section-number-5">3.2.6.2</span> Functions</h5>
<div class="outline-text-5" id="text-jsonnet-helper-functions">
<p>
Some data sub-structures are needed in multiple laces and it can be laborious to write them by hand.  Jsonnet provides functions to assist in this.  A number of functions are defined to assist in representing common data types. For example <code>point()</code> and <code>ray()</code>:
</p>
<div class="org-src-container">
<pre class="src src-js">{
  <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
  tracks : [ wc.ray(wc.point(10,0,0,wc.cm),
             wc.point(100,10,10,wc.cm)) ]
},
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd439725" class="outline-5">
<h5 id="default-parameters-in-jsonnet"><a id="user-content-default-parameters-in-jsonnet" class="anchor" href="#default-parameters-in-jsonnet" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgd439725"></a><span class="section-number-5">3.2.6.3</span> Default parameters</h5>
<div class="outline-text-5" id="text-default-parameters-in-jsonnet">
<p>
It is typical that different components must share common values, or separate values which derive from common values.  Jsonnet allows for this to be expressed in the configuration in a simple manner.  For example, in the <code>gen</code> package both <code>Drifter</code> and <code>Ductor</code> may apply statistical fluctuations.  For debugging it can be useful to turn this feature off.  This can be done in a consistent manner like in a global parameter file
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">in uboone/globals.json</span>
{
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">True if simulation should do fluctuations</span>
    fluctuate: <span style="font-weight: bold; text-decoration: underline;">true</span>,
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
}
</pre>
</div>

<p>
This file can then be imported so that this variable may be applied where ever it is needed.
</p>
<div class="org-src-container">
<pre class="src src-js"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">in uboone/components.jsonnet</span>
local params = <span style="font-weight: bold;">import</span> <span style="font-style: italic;">"uboone/globals.jsonnet"</span>;
{
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
    drifter: {
        type : <span style="font-style: italic;">"Drifter"</span>,
        data : {
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">... other parameters ...</span>
            fluctuate : params.fluctuate,
        }
    },
    ductor: {
        type : <span style="font-style: italic;">'Ductor'</span>,
        data : {
            <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">... other parameters ...</span>
            fluctuate : params.fluctuate,
        }
    },        
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
}
</pre>
</div>

<p>
See next how these definitions are used.
</p>
</div>
</div>

<div id="outline-container-org6d35d3a" class="outline-5">
<h5 id="default-data-structures-in-jsonnet"><a id="user-content-default-data-structures-in-jsonnet" class="anchor" href="#default-data-structures-in-jsonnet" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org6d35d3a"></a><span class="section-number-5">3.2.6.4</span> Default structures</h5>
<div class="outline-text-5" id="text-default-data-structures-in-jsonnet">
<p>
One useful way to factor a configuration is to have one Jsonnet file which holds default values and one or more that customize on top of those defaults.  For example one the <a href="https://github.com/WireCell/wire-cell-cfg/tree/master/uboone">MicroBooNE configuration</a> provided by <code>wire-cell-cfg</code> defines a default configuration for the <code>FourDee</code> WCT app.  
</p>

<div class="note">
<p>
An &ldquo;app&rdquo; is a top level main class run by WCT while an &ldquo;application&rdquo; refers to a program built with WCT that a user runs.
</p>

</div>

<p>
This app is configured with a list of components to use for certain portions of the &ldquo;FourDee&rdquo; simulation.  By default these can are configured with the default types provided directly in the <code>gen</code> package.  Note, these configuration are generally in the form <code>"TypeName:InstanceName"</code> but the defaults to not specify an instance name.
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">in uboone/components.json</span>
{
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
    fourdee : {
        type : <span style="font-style: italic;">'FourDee'</span>,
        data : {
            DepoSource: <span style="font-style: italic;">"TrackDepos"</span>,
            Drifter: <span style="font-style: italic;">"Drifter"</span>,
            Ductor: <span style="font-style: italic;">"Ductor"</span>,
            Dissonance: <span style="font-style: italic;">"SilentNoise"</span>,
            Digitizer: <span style="font-style: italic;">"Digitizer"</span>,
            FrameSink: <span style="font-style: italic;">"DumpFrames"</span>,            
        },
    },
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
}
</pre>
</div>

<p>
The default type for <code>FrameSink</code> is given as <code>DumpFrames</code>.  This component just prints a little bit of info to the terminal.  The user probably wants to be able to save the result of the simulation in some more useful way.  The <a href="https://github.com/WireCell/wire-cell-sio">simple I/O</a> package provides a <code>FrameSink</code> which will save the resulting simulated waveforms as 2D ROOT histograms.  The user merely needs to override <code>FrameSink</code> like:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">assumes user has this directory in their WIRECELL_PATH</span>
local uboone = <span style="font-weight: bold;">import</span> <span style="font-style: italic;">"uboone/components.jsonnet"</span>;
[
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">... skip other overrides ...</span>

    uboone.fourdee {
        data : <span style="font-weight: bold;">super</span>.data {
            FrameSink: <span style="font-style: italic;">"HistFrameSink"</span>,            
        }
    },
]
</pre>
</div>

<p>
This says to override <code>uboone.fourdee</code> with what&rsquo;s given.  The <code>type</code> is inherited.  The <code>data</code> is replaced by the parent&rsquo;s via <code>super.data</code> plus the additional override of the <code>FrameSink</code> attribute.
</p>
</div>
</div>

<div id="outline-container-org8a074ad" class="outline-5">
<h5 id="jsonnet-is-comma-friendly"><a id="user-content-jsonnet-is-comma-friendly" class="anchor" href="#jsonnet-is-comma-friendly" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org8a074ad"></a><span class="section-number-5">3.2.6.5</span> Commas</h5>
<div class="outline-text-5" id="text-jsonnet-is-comma-friendly">
<p>
One of the most irritating aspect of crafting JSON files by hand is that any array or object must <b>not</b> have an internal trailing comma.   Jsonnet allows this otherwise extraneous comma, as shown in the example above.  For this reason alone and if no other features are used, writing Jsonnet instead of raw JSON is worth the added dependency!
</p>
</div>
</div>
</div>

<div id="outline-container-org715db71" class="outline-4">
<h4 id="configuration-for-specific-detectors"><a id="user-content-configuration-for-specific-detectors" class="anchor" href="#configuration-for-specific-detectors" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org715db71"></a><span class="section-number-4">3.2.7</span> Specific detector support</h4>
<div class="outline-text-4" id="text-configuration-for-specific-detectors">
<p>
The <code>wire-cell-cfg</code> package also provides support for popular LArTPC detectors.  You can find these files under a directory named for the experiment  (such as <a href="https://github.com/WireCell/wire-cell-cfg/tree/master/uboone">that for MicroBooNE</a>).
</p>
</div>
</div>

<div id="outline-container-org57013be" class="outline-4">
<h4 id="jsonnet-command-line"><a id="user-content-jsonnet-command-line" class="anchor" href="#jsonnet-command-line" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org57013be"></a><span class="section-number-4">3.2.8</span> Using Jsonnet</h4>
<div class="outline-text-4" id="text-jsonnet-command-line">
<p>
Jsonnet&rsquo;s command line program <code>jsonnet</code> is fast and gives good error messages.  It&rsquo;s often easiest to develop a Jsonnet configuration with periodic checking.  Assuming the current working directory is the top of the WCT source then running the following: 
</p>

<pre class="example">
$ jsonnet -J cfg cfg/uboone/fourdee.jsonnet
</pre>

<p>
should reward you with a big screen full of JSON.  You can then run <code>wire-cell</code> something like:
</p>

<pre class="example">
$ wire-cell -c uboone/fourdee.jsonnet
</pre>

<p>
This relies on the <code>WIRECELL_PATH</code> to include the <code>cfg/</code> directory as well as any directories holding any configuration data files referenced by the configuration.
</p>
</div>
</div>
</div>


<div id="outline-container-org9a83da3" class="outline-3">
<h3 id="developer-configuration"><a id="user-content-developer-configuration" class="anchor" href="#developer-configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org9a83da3"></a><span class="section-number-3">3.3</span> <span class="todo TODO">TODO</span> Configuration from a developer point of view&#xa0;&#xa0;&#xa0;<span class="tag"><span class="devel">devel</span></span></h3>
<div class="outline-text-3" id="text-developer-configuration">
<p>
For the C++ part of developing WCT components or applications the developer should refer to the <a href="./internals.html#org954ba6a">configuration section in the manual on WCT Internals</a> and the <a href="#component-configuration">section on configuration implementation</a>.
</p>

<p>
In addition, a developer is encouraged to provide Jsonnet files that abstract away any less important details and give users a simplified way to configure the developers components.
</p>

<p>
In particular, if the developer writes multiple components, an application component or a component that refers to another component, working example configuration files should be provided.
</p>
</div>
</div>
</div>

<div id="outline-container-org332cf7b" class="outline-2">
<h2 id="howtos"><a id="user-content-howtos" class="anchor" href="#howtos" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org332cf7b"></a><span class="section-number-2">4</span> Howtos</h2>
<div class="outline-text-2" id="text-howtos">
<p>
This section of the manual gives brief guidance on how to do various things with WCT.
</p>
</div>

<div id="outline-container-org7eada24" class="outline-3">
<h3 id="run-wire-cell-cli"><a id="user-content-run-wire-cell-cli" class="anchor" href="#run-wire-cell-cli" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org7eada24"></a><span class="section-number-3">4.1</span> Run <code>wire-cell</code> command line program</h3>
<div class="outline-text-3" id="text-run-wire-cell-cli">
</div>
</div>


<div id="outline-container-org139fc84" class="outline-3">
<h3 id="add-a-component"><a id="user-content-add-a-component" class="anchor" href="#add-a-component" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org139fc84"></a><span class="section-number-3">4.2</span> Add a new component class</h3>
<div class="outline-text-3" id="text-add-a-component">
<p>
This describes the steps to add a Wire Cell Toolkit <i>component</i>.  As an example, it walks through the creation of a component which will produce noise waveforms.  The sections below are organized more or less in the order in which a developer advances from initial concept to design and implementation.
</p>
</div>

<div id="outline-container-org97605b0" class="outline-4">
<h4 id="component-concept"><a id="user-content-component-concept" class="anchor" href="#component-concept" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org97605b0"></a><span class="section-number-4">4.2.1</span> Conceptual design</h4>
<div class="outline-text-4" id="text-component-concept">
<p>
Noise waveforms will be generated based on a voltage amplitude spectrum represented in the frequency domain.  This amplitude will be sampled and abide by some fluctuation distribution and may have some parameters that allow for parametric scaling or other transformation so that the user may explore the results.  For simplicity, the time domain noise waveforms will be produced given a fixed sample period and readout time which will also be configurable.  It is assumed that the user arranges that these parameters, if needed elsewhere, are set consistently.  (See Sec. <a href="#configuration">3</a>).
</p>

<p>
Producing noise waveforms as described here require no other input data and in particular, none that would change over time or be a function of some &ldquo;event&rdquo;   So, the component will follow the pattern of being a <i>source</i> of data.  That is, waveforms will be produced on demand and in a manner which they are independent.  Below will show how this pattern is realized.
</p>
</div>
</div>

<div id="outline-container-org0ee77dd" class="outline-4">
<h4 id="component-dependencies"><a id="user-content-component-dependencies" class="anchor" href="#component-dependencies" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org0ee77dd"></a><span class="section-number-4">4.2.2</span> Estimating dependencies</h4>
<div class="outline-text-4" id="text-component-dependencies">
<p>
Before starting coding up an implementation it is prudent to understand what software dependencies are required to develop it.  Some trade-offs need to be understood.   Relying on &ldquo;external&rdquo; 3rd party packages to perform the &ldquo;heavy lifting&rdquo; of the implementation can make that implementation easier to develop.  However, adding dependencies increase the difficulty in installing and using the result on a wide variety of operating systems and system architectures.
</p>

<p>
Investigating dependencies before implementation also forces the developer to make an optimal decision that balances performance, support, documentation, ease of development, portability and a host of other qualifiers.  Relying on whatever software happens to be familiar and available forgoes making this optimal choice.
</p>

<p>
One touchstone that has been made by the WCT developers is that the &ldquo;core&rdquo; packages of WCT shall not depend on ROOT.  Depending on ROOT brings in many additional dependencies and this can limit, for example, usage on high-core architectures with limited RAM.  ROOT is very useful, and indeed parts of WCT depend on it (test, I/O packages) but for a package to be considered &ldquo;core&rdquo; its library must not require ROOT.  If a component requires ROOT or other package not accepted by the &ldquo;core&rdquo; packages then the component must be placed in an optional package (see Section <a href="#component-package">4.2.3</a>).
</p>

<p>
For the noise source, the main functionality required is drawing random variables from an arbitrary distribution (the noise spectrum) and drawing from some conventional distributions (for the fluctuation).  The spectrum can be provided through WCT configuration services and drawing from it is a simple algorithm based on forming the cumulative distribution that can be directly integrated.  Pseudo random number generation can be done directly in C++ or <a href="https://github.com/WireCell/wire-cell-iface/issues/2">when this ticket is closed</a> the WCT pRNG interface.
</p>
</div>
</div>

<div id="outline-container-org05e49a4" class="outline-4">
<h4 id="component-package"><a id="user-content-component-package" class="anchor" href="#component-package" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org05e49a4"></a><span class="section-number-4">4.2.3</span> Selecting a package</h4>
<div class="outline-text-4" id="text-component-package">
<p>
While the implementer is free to develop their component in any manner they wish, if the component is to be distributed as part of the WCT then its code needs to be in some WCT package.   For here, the main thing to note is that the <code>util</code> package is the lowest in the dependency tree, on top of it is <code>iface</code> (more on interfaces below) and above that are all the <i>implementation</i> packages.  The developer must choose an existing package or elect to make a new one depending on two main criteria: what dependencies are required and what implementation category does the component satisfy.
</p>

<p>
For the noise waveform source, given the relative lack of dependencies and the fact that it provides a simulation, the <a href="https://github.com/WireCell/wire-cell-gen">wire-cell-gen</a> package provides a suitable home.  If no suitable package exists the developer can see Section <a href="#packages">6</a> for details on WCT packages. 
</p>
</div>
</div>

<div id="outline-container-org6034bc2" class="outline-4">
<h4 id="component-interfaces"><a id="user-content-component-interfaces" class="anchor" href="#component-interfaces" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org6034bc2"></a><span class="section-number-4">4.2.4</span> Selecting interfaces</h4>
<div class="outline-text-4" id="text-component-interfaces">
<p>
All major functionality, and indeed the defining characteristic of a WCT <i>component</i> is that it implements one or more WCT <i>interfaces</i> which are C++ abstract base classes.  Each interface defines some number of methods that the implementation must provide.  
</p>

<p>
More information is in the Section <a href="#interface-internals">5.3</a> but for here, what is needed is that there are several categories of interfaces.  First, any set of related methods can be grouped into an otherwise anonymous interface.  One special interface is <code>IConfigurable</code> which is used if the implementation wishes to receive user-provided configuration information.  Another category contains the interfaces inheriting from <code>INode</code>.  An implementation inherits from one of these if it will participate in the <a href="#data-flow-programming">7</a> paradigm as implemented by WCT.  Or, more generally, if the component is expected to share or pass &ldquo;event&rdquo; data (but really any data) with other component.
</p>

<p>
The noise waveform source requires configuration and will be an <code>IFrameSource</code> as it will produce frames of &ldquo;traces&rdquo; (waveform segments).   As development progresses, it may come to light that portions of the implementation are general and are factored into separate classes which themselves may be accessed via an Interface.
</p>
</div>
</div>

<div id="outline-container-org2d881db" class="outline-4">
<h4 id="component-header"><a id="user-content-component-header" class="anchor" href="#component-header" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org2d881db"></a><span class="section-number-4">4.2.5</span> Component header</h4>
<div class="outline-text-4" id="text-component-header">
<p>
Developing the noise source component begins with a header file which ties together the interfaces through inheritance, declares the interface methods to be implemented and any private methods and data the implementation may need.    Following the layout conventions this header is placed in <a href="https://github.com/WireCell/wire-cell-gen/blob/master/inc/WireCellGen/NoiseSource.h">gen/inc/WireCellGen/NoiseSource.h</a>.  Some features to note:
</p>

<ul class="org-ul">
<li>use <code>#ifndef/#define/#endif</code> include protection</li>
<li>place inside <code>WireCell</code> namespace and a subnamespace that names the implementation (<code>Gen</code>) in this case</li>
<li>add methods for each interface.  Due to the templating used in the node interfaces it&rsquo;s not always obvious which methods must be implemented unless one follows their inheritence tree.  However, most high level interfaces based on <code>INode</code> should provide a comment in their header file giving what to implement.</li>
</ul>
</div>
</div>

<div id="outline-container-orgd4232f1" class="outline-4">
<h4 id="component-implementation"><a id="user-content-component-implementation" class="anchor" href="#component-implementation" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgd4232f1"></a><span class="section-number-4">4.2.6</span> Component implementation</h4>
<div class="outline-text-4" id="text-component-implementation">
<p>
The implementation of a component, 
following the layout conventions this header, is placed in <a href="https://github.com/WireCell/wire-cell-gen/blob/master/inc/WireCellGen/NoiseSource.h">gen/src/NoiseSource.cxx</a>.  
</p>
</div>

<div id="outline-container-orgc850fde" class="outline-5">
<h5 id="component-boilerplate"><a id="user-content-component-boilerplate" class="anchor" href="#component-boilerplate" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgc850fde"></a><span class="section-number-5">4.2.6.1</span> Component boilerplate</h5>
<div class="outline-text-5" id="text-component-boilerplate">
<p>
A few lines of boilerplate are needed so that the component can be dynamically resolved by WCT.  Toward the top of the file, and in particular before any <code>using namespace</code> statements the following is needed.
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">"WireCellUtil/NamedFactory.h"</span>

WIRECELL_FACTORY(NoiseSource, <span style="font-weight: bold; text-decoration: underline;">WireCell</span>::<span style="font-weight: bold; text-decoration: underline;">Gen</span>::NoiseSource, <span style="font-weight: bold; text-decoration: underline;">WireCell</span>::IFrameSource, <span style="font-weight: bold; text-decoration: underline;">WireCell</span>::IConfigurable);
</pre>
</div>


<p>
This is a CPP macro with the following arguments:
</p>

<ul class="org-ul">
<li>The &ldquo;type name&rdquo; of the component (without quotes).  This is usually the C++ class name with any namespaces removed but it may differ.  It should be unique across all components</li>
<li>The C++ type of the component</li>
<li>The remaining arguments are variable in length and enumerate all interfaces through which this component may be accessed.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf23f2f8" class="outline-5">
<h5 id="component-configuration"><a id="user-content-component-configuration" class="anchor" href="#component-configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgf23f2f8"></a><span class="section-number-5">4.2.6.2</span> Configuration implementation</h5>
<div class="outline-text-5" id="text-component-configuration">
<p>
A WCT <i>configurable component</i> must provide two methods.  The first returns a default configuration object via the <code>default_configuration()</code> method.  This object should represent as much of a working configuration as is possible to specify using hard-coded or otherwise default knowledge.  If some parameter can not meaningfully be given a default value it should nonetheless be included with some default, possibly bogus value, eg <code>null</code>, <code>0</code> or empty string or list.  This can then be dumped via the <code>wire-cell</code> command line program as JSON to give the user guidance on how to provide correct input.
</p>

<p>
The second method <code>configure()</code> accepts a configuration object from WCT and applies it to any internal state.  The component should expect this configuration object to follow a data schema determined by the component itself.  The developer of the component should document this schema so that users know what to provide.  When accessing the configuration object the code should, where possible, allow for missing parameters by substituting defaults.  The code should also be written to allow and ignore any unknown parts of the data structure to the extent that the intended data schema is not otherwise violated.
</p>

<p>
The component may also provide a constructor or other method which takes configuration in any form.  This can be useful to facilitate developing unit tests for the component to allow configuration to be directly set.  A common pattern is to let configuration information &ldquo;flow&rdquo; starting from the constructor, into private data members of the component, and then out through <code>default_configuration()</code> and finally used to provide default values when accessing the user configuration object inside <code>configure()</code>.  This is illustrated in this <code>NoiseSource</code> example. 
</p>

<div class="warning">
<p>
A component must have a constructor that takes no arguments.  If a constructor which takes arguments is added its arguments must either all have default values or a second argument-free constructor must be also included.
</p>

</div>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-orgfcf354c" class="outline-2">
<h2 id="internals"><a id="user-content-internals" class="anchor" href="#internals" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgfcf354c"></a><span class="section-number-2">5</span> Internals</h2>
<div class="outline-text-2" id="text-internals">
<p>
This doc describes the Wire Cell Toolkit (WCT) internal structure and support facilities.  It is intended for developers to read carefully, understand and follow.  It may be of interest to users as well.   It does not cover the &ldquo;batteries included&rdquo; or &ldquo;reference implementations&rdquo; such as the simulation, signal processing, imaging, etc which are described in section <a href="#packages">6</a>.
</p>
</div>

<div id="outline-container-org180c376" class="outline-3">
<h3 id="toolkit-packages"><a id="user-content-toolkit-packages" class="anchor" href="#toolkit-packages" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org180c376"></a><span class="section-number-3">5.1</span> Toolkit packages</h3>
<div class="outline-text-3" id="text-toolkit-packages">
<p>
The WCT is composed of a number of <i>packages</i>.  Each package has an associated with a Git source repository.
Most packages produce a shared library, which may also be a WCT plugin library, C++ header files, some number of main or test applications.   Others include a single package holding all Python code in various modules, a package providing support for developing WCT configuration files and the documentation package holding this document.
One special type of package is a <i>build</i> package described more in section on the build package.
</p>
</div>

<div id="outline-container-org902f2d1" class="outline-4">
<h4 id="package-names"><a id="user-content-package-names" class="anchor" href="#package-names" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org902f2d1"></a><span class="section-number-4">5.1.1</span> Names</h4>
<div class="outline-text-4" id="text-package-names">
<p>
Package repositories are named like <code>wire-cell-&lt;name&gt;</code> where <code>&lt;name&gt;</code> is some short identifier giving indication of the main scope of the package.  In the documentation the <code>wire-cell-</code> prefix is often dropped and only this short name is used.  
</p>

<p>
If a package produces a shared library it should be named in <code>CamelCase</code> with a prefix <code>WireCell</code>.  For example the <code>gen</code> package produces a library <code>libWireCellGen.so</code>.  As a plugin name or an entry in the build system, the <code>lib</code> and <code>.so</code> are dropped.  If the package has public header files to expose to other packages they should use this same name for a subdirectory in which to hold them.  Package layout is described move below.
</p>
</div>
</div>

<div id="outline-container-orga8f1121" class="outline-4">
<h4 id="package-dependencies"><a id="user-content-package-dependencies" class="anchor" href="#package-dependencies" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orga8f1121"></a><span class="section-number-4">5.1.2</span> Dependencies</h4>
<div class="outline-text-4" id="text-package-dependencies">
<p>
Some of the C++ packages are designated as <i>core</i> packages.  These include the packages providing the toolkit C++ structure (described later in this document) as well as the reference implementations (eg, <code>gen</code>, <code>sigproc</code>).   These packages have strict requirements on what dependencies may be introduced and in particular their shared libraries are not allowed to depend on ROOT (although their apps and tests are, see sections <a href="#package-structure">5.1.3</a> and <a href="#build-package">5.1.4</a>).
</p>

<p>
The base package is <code>util</code> and it <i>must</i> not depend on any other WCT package.  The next most basic is <code>iface</code> and it <i>must</i> not depend on any other WCT except <code>util</code>.  Core implementation packages such as <code>gen</code> or <code>sigproc</code> may depend on both but should not depend on each other.
</p>

<p>
Fixme: there is a need to factor some general utility routines and data structures that depend on <code>iface</code> and which the implementation packages should use that needs to be created.
</p>

<p>
WCT also provides a number of peripheral implementation packages, which are free to have more dependencies, including ROOT, than &ldquo;core&rdquo; packages.  These are mostly for the purpose of providing WCT components which provide file I/O.  The <code>sst</code> package in particular support the so called <code>celltree</code> ROOT <code>TTree</code> format used by the Wire Cell prototype code.
</p>

<p>
Finally, there may be third-party implementation packages.  They are free to mimic WCT packages but WCT itself will not depend on them.  They should not make use of the <code>WireCell::</code> C++ namespace.
</p>
</div>
</div>

<div id="outline-container-org1fb5a4f" class="outline-4">
<h4 id="package-structure"><a id="user-content-package-structure" class="anchor" href="#package-structure" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org1fb5a4f"></a><span class="section-number-4">5.1.3</span> Package structure</h4>
<div class="outline-text-4" id="text-package-structure">
<p>
The WCT package layout and file extensions must follow some conventions in order to greatly simplify the build system.  In the description below, <code>WireCellName</code> is as described above.
</p>

<dl class="org-dl">
<dt><code>src/*.cxx</code></dt><dd>C++ source file for libraries with .cxx extensions or private headers</dd>
<dt><code>inc/WireCellName/*.h</code></dt><dd>public/API C++ header files with .h extensions</dd>
<dt><code>test/test_*.cxx</code></dt><dd>main C++ programs named like test<sub>*</sub>.cxx, may also hold Python, shell scripts, private headers</dd>
<dt><code>apps/*.cxx</code></dt><dd>main application(s), one appname.cxx file for each app named <code>appname</code>, should be very limited in number</dd>
</dl>

<p>
In the root of each C++ package directory must exist a file called <code>wscript_build</code>.  It typically consist of a single line with a method call like:
</p>

<div class="org-src-container">
<pre class="src src-python">bld.smplpkg(<span style="font-style: italic;">'WireCellName'</span>, use=<span style="font-style: italic;">'...'</span>)
</pre>
</div>
<p>
The <code>bld</code> object is automagically available.  If the package has no dependencies then only the name is given.  Most packages will need to specify some dependencies via <code>use</code> or may specify a different list of dependencies just for any applications (using <code>app_use</code>) or for the test programs (via <code>test_use</code>).  Dependencies are transitive so one must only list those on which the package directly depends.
</p>

<p>
Fixme: make a script that generates a dot file and show the graph.
</p>
</div>
</div>

<div id="outline-container-org67748b0" class="outline-4">
<h4 id="build-package"><a id="user-content-build-package" class="anchor" href="#build-package" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org67748b0"></a><span class="section-number-4">5.1.4</span> Build package</h4>
<div class="outline-text-4" id="text-build-package">
<p>
To actually build WCT see the section on toolkit installation (section <a href="#installation">2</a>).  The build system is based on <a href="https::waf.io">Waf</a> and uses the <code>wcb</code> command and a <code>wscript</code> file provided by the top level <i>build package</i>.  More details on the build system are given in section <a href="#pkg-waftools">Waf tools</a>.
</p>

<p>
Besides holding the main build instructions this package aggregates all the other packages via Git&rsquo;s &ldquo;submodule&rdquo; feature.  In principle, there may be more than one build package maintained.  This allows developers working on a subset to avoid having to build unwanted code.  In practice there is a single build package which is at: <a href="https://github.com/wirecell/wire-cell-build">https://github.com/wirecell/wire-cell-build</a>.
</p>
</div>
</div>


<div id="outline-container-org741bcdf" class="outline-4">
<h4 id="add-new-package-to-build"><a id="user-content-add-new-package-to-build" class="anchor" href="#add-new-package-to-build" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org741bcdf"></a><span class="section-number-4">5.1.5</span> Adding a new code package</h4>
<div class="outline-text-4" id="text-add-new-package-to-build">
<p>
To add a new code package to a build package from scratch, select a <code>&lt;name&gt;</code> following guidance above and do something like:
</p>
<pre class="example">
$ mkdir &lt;name&gt;
$ cd &lt;name&gt;/
$ echo "bld.smplpkg('WireCell&lt;Name&gt;', use='WireCellUtil WireCellIface')" &gt; wscript_build
$ git init
$ git add wscript_build
$ git commit -a -m "Start code package &lt;name&gt;"
</pre>
<p>
Replace <code>&lt;name&gt;</code> with your package name.  You can create and commit actual code at this time as well following the layout in <a href="#package-structure">5.1.3</a>.
</p>

<p>
Now, make a new repository by going to the <a href="https://github.com/WireCell">WireCell GitHub</a> and clicking &ldquo;New repository&rdquo; button. Give it a name like <code>wire-cell-&lt;name&gt;</code>.  Copy-and-paste the two command it tells you to use:
</p>
<pre class="example">
$ git remote add origin git@github.com:WireCell/wire-cell-&lt;name&gt;.git
$ git push -u origin master
</pre>
<p>
If you made your initial package directory inside the build package move it aside.  Then, from the build package directory, add this new repository as a Git submodule:
</p>
<pre class="example">
$ cd wire-cell-build/ # or whatever you named it
$ git submodule add -- git@github.com:WireCell/wire-cell-&lt;name&gt;.git &lt;name&gt;
$ git submodule update
$ git commit -a -m "Added &lt;name&gt; to top-level build package."
$ git push
</pre>
<p>
In order to be picked up by the build the new package short name must be added to the <code>wscript</code> file.
</p>
</div>
</div>
</div>




<div id="outline-container-org7ddbeb2" class="outline-3">
<h3 id="coding-conventions"><a id="user-content-coding-conventions" class="anchor" href="#coding-conventions" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org7ddbeb2"></a><span class="section-number-3">5.2</span> Coding conventions</h3>
<div class="outline-text-3" id="text-coding-conventions">
</div>


<div id="outline-container-org0212ea3" class="outline-4">
<h4 id="c++-code-formatting"><a id="user-content-c++-code-formatting" class="anchor" href="#c++-code-formatting" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org0212ea3"></a><span class="section-number-4">5.2.1</span> C++ code formatting</h4>
<div class="outline-text-4" id="text-c++-code-formatting">
<ul class="org-ul">
<li>Base indentation <i>should</i> be four spaces.</li>

<li>Tabs <i>should</i> not be used.</li>

<li>Opening braces <i>should not</i> be on a line onto themselves, closing braces <i>should be</i>.</li>

<li>Class names <i>should</i> follow <code>CamelCase</code>, method and function names <i>should</i> follow <code>snake_case</code>, class data attributes  <i>should</i> be prefixed with <code>m_</code> (signifying &ldquo;member&rdquo;).</li>

<li>Doxygen triple-slash <code>///</code> or double-star <code>/** */</code> comments <i>must</i> be used for in-source reference documentation.</li>

<li>Normal comments <i>may</i> be used for implementation documentation.</li>

<li>Interface classes and their types and methods <i>must</i> each have a documenting Doxygen comment.</li>

<li>Header files <i>must</i> have <code>#ifndef/#define/#endif</code> protection.</li>

<li>The C++ <code>using namespace</code> keyword <i>must not</i> be used at top file scope in a header.</li>

<li>Unused headers <i>should not</i> be retained.</li>

<li>Any =#include# need in an implementation file but not the corresponding header file <i>should not</i> be in the header file.</li>
</ul>
</div>
</div>


<div id="outline-container-orgfb8331c" class="outline-4">
<h4 id="c++-namespaces"><a id="user-content-c++-namespaces" class="anchor" href="#c++-namespaces" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgfb8331c"></a><span class="section-number-4">5.2.2</span> C++ namespaces</h4>
<div class="outline-text-4" id="text-c++-namespaces">
<ul class="org-ul">
<li>All C++ code part of WCT proper and which may be accessed by other packages (eg, exported via &ldquo;public headers&rdquo;) <i>must</i> be under the <code>WireCell::</code> namespace.</li>

<li>WCT core code (<code>util</code> and <code>iface</code> packages) <i>may</i> exist directly under <code>WireCell::</code> but bare functions <i>must</i> be in a sub namespace.</li>

<li>Non-core, WCT implementation code (eg contents of <code>gen</code> package) <i>must</i> use secondary namespace (eg <code>WireCell::Gen::</code>).</li>

<li>Any third-party packages providing WCT-based components or otherwise depending on WCT <i>should not</i> use the <code>WireCell::</code> namespace.</li>
</ul>
</div>
</div>


<div id="outline-container-org20aae1a" class="outline-4">
<h4 id="configuration-conventions"><a id="user-content-configuration-conventions" class="anchor" href="#configuration-conventions" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org20aae1a"></a><span class="section-number-4">5.2.3</span> Configuration Parameters</h4>
<div class="outline-text-4" id="text-configuration-conventions">
<ul class="org-ul">
<li>Configuration parameter names should follow <code>snake_case</code>.</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-orgbd8f08d" class="outline-3">
<h3 id="interface-internals"><a id="user-content-interface-internals" class="anchor" href="#interface-internals" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgbd8f08d"></a><span class="section-number-3">5.3</span> Interfaces</h3>
<div class="outline-text-3" id="text-interface-internals">
<p>
A central design aspect of the WCT is that all &ldquo;important&rdquo; functionality which may have more than one implementation must be accessed via an <i>pure abstract interface class</i>.  All such interface classes are held in the <a href="https://github.com/wirecell/wire-cell-iface">iface</a> package.  Interface classes should present a very limited number of purely abstract methods that express a single, cohesive concept.  Implementations typically inherent from more than one interface.  If two concepts are close but not cohesive they are best put into two interface classes.
Besides defining the method interface, Interface classes may define types.  They may also be templated.
</p>

<p>
After an implementation of an interface is instantiated and leaves local scope it should be referenced only through one of its interfaces.  It should be held through an appropriately typed <code>std::shared_ptr&lt;&gt;</code> of which one should be defined as <code>ITheInterface::pointer</code>.
</p>

<p>
Interfaces are used not only to access functionality but the data model for major working data is defined in terms of interfaces inheriting from <code>WireCell::IData</code>.  Once an instance is created it is immutable.
</p>

<p>
Another category of interfaces are those which express the &ldquo;node&rdquo; concept.  They inherit from <code>WireCell::INode</code>.  These require implementation of an <code>operator()</code> method.   Nodes make up the main unit of code.  They are somewhat equivalent to <code>Algorithm</code> concept from the Gaudi framework where the <code>operator()</code> method is equivalent to Gaudi&rsquo;s <code>execute()</code> method.  They also require some additional instrumenting in order to participate in the data flow programming paradigm described below.
</p>
</div>
</div>

<div id="outline-container-org445a0a2" class="outline-3">
<h3 id="component-internals"><a id="user-content-component-internals" class="anchor" href="#component-internals" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org445a0a2"></a><span class="section-number-3">5.4</span> Components</h3>
<div class="outline-text-3" id="text-component-internals">
<p>
Components are implementations an interface which itself inherits from the <code>WireCell::IComponponent</code> interface class (this interface class is in <code>util</code> as a special case due to dependency issues.  fixme: needs to be solved with a general package depending on both <code>iface and =util</code>).  This inheritance follows <a href="https://en.wikipedia.org/wiki/Curiously_recurring_template_pattern">CRTP</a>.
</p>

<p>
Components also must have some tooling added in their implementation file.  This is in the form of a single CPP macro which generates a function used to load a factory that can create and retain instances based on a <i>type</i> name and an <i>instance</i> name.  For <code>WireCell::Gen::TrackDepos</code> the tooling looks like:
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">"WireCellUtil/NamedFactory.h"</span>
WIRECELL_FACTORY(TrackDepos, <span style="font-weight: bold; text-decoration: underline;">WireCell</span>::<span style="font-weight: bold; text-decoration: underline;">Gen</span>::TrackDepos, <span style="font-weight: bold; text-decoration: underline;">WireCell</span>::IDepoSource, <span style="font-weight: bold; text-decoration: underline;">WireCell</span>::IConfigurable);
</pre>
</div>
<p>
Note, this macro needs to appear before any <code>using namespace</code> directives.  The arguments to the macro are:
</p>

<ol class="org-ol">
<li>The &ldquo;type name&rdquo; which is typically the class name absent any namespace prefixes.  It must be unique across the entire WCT application.</li>
<li>The full class name.</li>
<li>A list of all interfaces that it implements.</li>
</ol>

<p>
A component may be retrieved as an interface using the <i>named factory pattern</i> implemented in WCT.  If the component has yet to be instantiated it will be through this lookup.  This is performed with code like:
</p>

<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold;">#include</span> <span style="font-style: italic;">"WireCellUtil/NamedFactory.h"</span>
<span style="font-weight: bold;">auto</span> <span style="font-weight: bold; text-decoration: underline;">a</span> = <span style="font-weight: bold; text-decoration: underline;">Factory</span>::<span style="font-weight: bold; text-decoration: underline;">lookup</span>&lt;IConfigurable&gt;(<span style="font-style: italic;">"TrackeDepos"</span>);
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">or</span>
<span style="font-weight: bold;">auto</span> <span style="font-weight: bold; text-decoration: underline;">b</span> = <span style="font-weight: bold; text-decoration: underline;">Factory</span>::<span style="font-weight: bold; text-decoration: underline;">lookup</span>&lt;IConfigurable&gt;(<span style="font-style: italic;">"TrackeDepos"</span>,<span style="font-style: italic;">"some instance name"</span>);
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">or</span>
<span style="font-weight: bold;">auto</span> <span style="font-weight: bold; text-decoration: underline;">c</span> = <span style="font-weight: bold; text-decoration: underline;">Factory</span>::<span style="font-weight: bold; text-decoration: underline;">lookup_tn</span>&lt;IConfigurable&gt;(<span style="font-style: italic;">"TrackeDepos:"</span>);
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">or</span>
<span style="font-weight: bold;">auto</span> <span style="font-weight: bold; text-decoration: underline;">d</span> = <span style="font-weight: bold; text-decoration: underline;">Factory</span>::<span style="font-weight: bold; text-decoration: underline;">lookup_tn</span>&lt;IConfigurable&gt;(<span style="font-style: italic;">"TrackeDepos:some instance name"</span>);
</pre>
</div>
<p>
The four example differ in if an instance name is known and if it is known separately from the type name or in the canonical join (eg as <code>type:name</code>).  The returned value in this example is a <code>std::shared_ptr&lt;const IConfigurable&gt;</code>.  This example accesses the <code>IConfigurable</code> interface of <code>TrackDepos</code>.  
Not typically required by most code but there exists also a function <code>lookup_factory()</code> to get the factory that constructs the component instance.
</p>
</div>
</div>


<div id="outline-container-orgfa0abbc" class="outline-3">
<h3 id="configuration-internals"><a id="user-content-configuration-internals" class="anchor" href="#configuration-internals" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgfa0abbc"></a><span class="section-number-3">5.5</span> Configuration</h3>
<div class="outline-text-3" id="text-configuration-internals">
<p>
One somewhat special component interface is <code>IConfigurable</code>.  A class inheriting from this interface is considered a <i>configurable component</i> such as <code>TrackDepos</code> in the above example.  It is <i>required</i> for any main application using the WCT toolkit to adhere to the Wire Cell Toolkit Configuration Protocol.  This is a contract by which the main application promises to do the following:
</p>

<ol class="org-ol">
<li>Load in user-provided configuration information (see the configuration section of hte manual)</li>
<li>Instantiate all configurables referenced in that configuration.</li>
<li>Request the default configuration object from each instance.</li>
<li>Update that object with, potentially partial, information provided by the user.</li>
<li>Give the instance the updated configuration object.</li>
<li>Do this before entering any execution phase of the application.</li>
</ol>
<p>
If the main application uses <code>WireCell::Toolkit</code> then the protocol can be enacted with code similar to 
</p>
<div class="org-src-container">
<pre class="src src-c++"><span style="font-weight: bold;">using</span> <span style="font-weight: bold;">namespace</span> <span style="font-weight: bold; text-decoration: underline;">WireCell</span>;
<span style="font-weight: bold; text-decoration: underline;">ConfigManager</span> <span style="font-weight: bold;">cfgmgr</span>();
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">... load up cfgmgr</span>
<span style="font-weight: bold;">for</span> (<span style="font-weight: bold;">auto</span> <span style="font-weight: bold; text-decoration: underline;">c</span> : cfgmgr.all()) {
    <span style="font-weight: bold; text-decoration: underline;">string</span> <span style="font-weight: bold; font-style: italic;">type</span> = <span style="font-weight: bold; text-decoration: underline;">get</span>&lt;string&gt;(c, <span style="font-style: italic;">"type"</span>);
    <span style="font-weight: bold; text-decoration: underline;">string</span> <span style="font-weight: bold; font-style: italic;">name</span> = <span style="font-weight: bold; text-decoration: underline;">get</span>&lt;string&gt;(c, <span style="font-style: italic;">"name"</span>);
    <span style="font-weight: bold;">auto</span> <span style="font-weight: bold; text-decoration: underline;">cfgobj</span> = <span style="font-weight: bold; text-decoration: underline;">Factory</span>::<span style="font-weight: bold; text-decoration: underline;">lookup</span>&lt;IConfigurable&gt;(type, name); <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">throws </span>
    <span style="font-weight: bold; text-decoration: underline;">Configuration</span> <span style="font-weight: bold; font-style: italic;">cfg</span> = cfgobj-&gt;default_configuration();
    cfg = update(cfg, c[<span style="font-style: italic;">"data"</span>]);
    cfgobj-&gt;configure(cfg);
}
</pre>
</div>
<p>
FIXME: shouldn&rsquo;t we put this all inside <code>ConfigManager</code>?
</p>

<p>
Developers of new configurables should keep this protocol in mind and should refer to existing configurables for various useful patterns to provide their end of the exchange.
</p>
</div>
</div>




<div id="outline-container-org6e69c7d" class="outline-3">
<h3 id="execution-models"><a id="user-content-execution-models" class="anchor" href="#execution-models" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org6e69c7d"></a><span class="section-number-3">5.6</span> Execution Models</h3>
<div class="outline-text-3" id="text-execution-models">
</div>

<div id="outline-container-orgd8a446b" class="outline-4">
<h4 id="ad-hoc-execution"><a id="user-content-ad-hoc-execution" class="anchor" href="#ad-hoc-execution" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgd8a446b"></a><span class="section-number-4">5.6.1</span> Ad-hoc</h4>
<div class="outline-text-4" id="text-ad-hoc-execution">
<p>
Direct calling of utility functions and concrete objects.
</p>
</div>
</div>

<div id="outline-container-org457d534" class="outline-4">
<h4 id="execution-concrete-components"><a id="user-content-execution-concrete-components" class="anchor" href="#execution-concrete-components" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org457d534"></a><span class="section-number-4">5.6.2</span> Concrete</h4>
<div class="outline-text-4" id="text-execution-concrete-components">
<p>
Concrete components.
</p>
</div>
</div>

<div id="outline-container-org9433e72" class="outline-4">
<h4 id="execution-via-interfaces"><a id="user-content-execution-via-interfaces" class="anchor" href="#execution-via-interfaces" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org9433e72"></a><span class="section-number-4">5.6.3</span> Interface</h4>
<div class="outline-text-4" id="text-execution-via-interfaces">
<p>
Using NamedFactory.
</p>
</div>
</div>

<div id="outline-container-org339220a" class="outline-4">
<h4 id="dfp-execution"><a id="user-content-dfp-execution" class="anchor" href="#dfp-execution" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org339220a"></a><span class="section-number-4">5.6.4</span> Data flow programming execution</h4>
<div class="outline-text-4" id="text-dfp-execution">
<p>
Using abstract DFP.  A whole section on <a href="#data-flow-programming">7</a> is also available.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org9ddbb68" class="outline-2">
<h2 id="packages"><a id="user-content-packages" class="anchor" href="#packages" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org9ddbb68"></a><span class="section-number-2">6</span> Packages</h2>
<div class="outline-text-2" id="text-packages">
</div>


<div id="outline-container-orgfa69d87" class="outline-3">
<h3 id="pkg-python"><a id="user-content-pkg-python" class="anchor" href="#pkg-python" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgfa69d87"></a><span class="section-number-3">6.1</span> <code>wire-cell-python</code></h3>
<div class="outline-text-3" id="text-pkg-python">
<p>
Wire Cell Toolkit provides some support for Python and requires it for some preprocessing, plotting and validation.  This support is held in the <a href="https://github.com/wirecell/wire-cell-python">wire-cell-python</a> package
</p>
</div>

<div id="outline-container-org84bfa6e" class="outline-4">
<h4 id="install-wire-cell-python"><a id="user-content-install-wire-cell-python" class="anchor" href="#install-wire-cell-python" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org84bfa6e"></a><span class="section-number-4">6.1.1</span> Installing <code>wire-cell-python</code></h4>
<div class="outline-text-4" id="text-install-wire-cell-python">
<p>
It&rsquo;s just a &ldquo;normal&rdquo; Python package.  Use your favorite method, such as
</p>

<pre class="example">
$ virtualenv --system-site-packages venv
$ source venv/bin/activate
$ git clone https://github.com/WireCell/wire-cell-python.git
$ cd wire-cell-python/
$ python setup.py develop  
$ wirecell-sigproc --help
</pre>
</div>
</div>

<div id="outline-container-orgc298ada" class="outline-4">
<h4 id="python-programs"><a id="user-content-python-programs" class="anchor" href="#python-programs" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgc298ada"></a><span class="section-number-4">6.1.2</span> Python command line programs</h4>
<div class="outline-text-4" id="text-python-programs">
<p>
A number of python command line programs are provided.  They are typically named like:
</p>

<pre class="example">
wirecell-&lt;name&gt;
</pre>
<p>
Where <code>&lt;name&gt;</code> is one a package short name (eg, <code>util</code>, <code>sigproc</code>, <code>gen</code>).
</p>

<p>
All use the same command line interface (CLI) module (<a href="http://click.pocoo.org/">Click</a>) so have similar usage.  In particular, run the program without any arguments to get a help screen.
</p>
</div>
</div>


<div id="outline-container-org42d9f53" class="outline-4">
<h4 id="python-modules"><a id="user-content-python-modules" class="anchor" href="#python-modules" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org42d9f53"></a><span class="section-number-4">6.1.3</span> <code>wirecell</code> Python modules</h4>
<div class="outline-text-4" id="text-python-modules">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wirecell <span style="font-weight: bold;">import</span> units
</pre>
</div>
</div>

<div id="outline-container-orgd67c173" class="outline-5">
<h5 id="orgd67c173"><a id="user-content-orgd67c173" class="anchor" href="#orgd67c173" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-5">6.1.3.1</span> <code>sigproc</code></h5>
<div class="outline-text-5" id="text-6-1-3-1">
</div><ol class="org-ol"><li><a id="org7dabf22"></a><code>garfield</code><br /><div class="outline-text-6" id="text-6-1-3-1-1">
<p>
See the section <a href="#garfield-2d-support">8.1</a>.
</p>
</div></li></ol>
</div>
</div>
</div>

<div id="outline-container-org774be52" class="outline-3">
<h3 id="pkg-util"><a id="user-content-pkg-util" class="anchor" href="#pkg-util" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org774be52"></a><span class="section-number-3">6.2</span> <code>wire-cell-util</code></h3>
<div class="outline-text-3" id="text-pkg-util">
<p>
Introduction.
</p>
</div>

<div id="outline-container-orgeaf07cb" class="outline-4">
<h4 id="util-units"><a id="user-content-util-units" class="anchor" href="#util-units" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgeaf07cb"></a><span class="section-number-4">6.2.1</span> Units</h4>
<div class="outline-text-4" id="text-util-units">
<p>
Describe units.
</p>
</div>
</div>

<div id="outline-container-org716ce59" class="outline-4">
<h4 id="util-persistence"><a id="user-content-util-persistence" class="anchor" href="#util-persistence" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org716ce59"></a><span class="section-number-4">6.2.2</span> Persistence</h4>
<div class="outline-text-4" id="text-util-persistence">
<p>
Describe support for persistent files including compression and location.
</p>
</div>
</div>

<div id="outline-container-org7e8da6b" class="outline-4">
<h4 id="org7e8da6b"><a id="user-content-org7e8da6b" class="anchor" href="#org7e8da6b" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.2.3</span> Etc</h4>
<div class="outline-text-4" id="text-6-2-3">
<p>
&#x2026;.
</p>
</div>
</div>
</div>

<div id="outline-container-org47f8ca0" class="outline-3">
<h3 id="pkg-iface"><a id="user-content-pkg-iface" class="anchor" href="#pkg-iface" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org47f8ca0"></a><span class="section-number-3">6.3</span> <code>wire-cell-iface</code></h3>
<div class="outline-text-3" id="text-pkg-iface">
<p>
Brief overview but it&rsquo;s also in <a href="./internals.html">./internals.html</a> so don&rsquo; t over do it.
</p>
</div>

<div id="outline-container-org9584164" class="outline-4">
<h4 id="org9584164"><a id="user-content-org9584164" class="anchor" href="#org9584164" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.3.1</span> Data</h4>
<div class="outline-text-4" id="text-6-3-1">
<p>
tbd
</p>
</div>
</div>

<div id="outline-container-orgfda9dc7" class="outline-4">
<h4 id="orgfda9dc7"><a id="user-content-orgfda9dc7" class="anchor" href="#orgfda9dc7" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.3.2</span> Nodes</h4>
<div class="outline-text-4" id="text-6-3-2">
<p>
tbd
</p>
</div>
</div>

<div id="outline-container-org0320f66" class="outline-4">
<h4 id="org0320f66"><a id="user-content-org0320f66" class="anchor" href="#org0320f66" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.3.3</span> Misc</h4>
<div class="outline-text-4" id="text-6-3-3">
<p>
tbd
</p>
</div>
</div>
</div>

<div id="outline-container-org86ad5c8" class="outline-3">
<h3 id="pkg-gen"><a id="user-content-pkg-gen" class="anchor" href="#pkg-gen" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org86ad5c8"></a><span class="section-number-3">6.4</span> <code>wire-cell-gen</code></h3>
<div class="outline-text-3" id="text-pkg-gen">
<p>
The <code>wire-cell-gen</code> package provides components for the generation of data.  It primarily includes components which perform the grand convolution of drifted electron distribution, field and electronics response and associate statistical fluctuations (aka, the &ldquo;drift simulation&rdquo;).
</p>
</div>

<div id="outline-container-org069809f" class="outline-4">
<h4 id="org069809f"><a id="user-content-org069809f" class="anchor" href="#org069809f" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.4.1</span> Depositions</h4>
<div class="outline-text-4" id="text-6-4-1">
<p>
Depositions (<code>IDepo</code> data objects, aka <i>depo</i>) are provided by <code>IDepoSource</code> components.  A single depo is provided on each call to the source and are expected to be produce in <i>strict time order</i>.  In general a depo represents a 2D  distribution (ie, Gaussian) of drifting electrons spread in longitudinal and transverse directions.  A depo may be confined to a single point where the two <i>extents</i> of the distribution are zero.  
</p>

<p>
The <code>IDepoSource</code> components adapt to external sources of information about initial activity in the detector.  These sources may provide \(dE\) and \(dX\) in which case two models can be applied to produce associated number of ionized electrons.  The external source may provide only \(dE\) in which case the number of ionized electrons will be calculated for the deposition on the assumption that the particle is a MIP.  Finally, the ionization process may be handled by the external source and the number of electrons may be given directly.
</p>
</div>
</div>

<div id="outline-container-org182aaae" class="outline-4">
<h4 id="org182aaae"><a id="user-content-org182aaae" class="anchor" href="#org182aaae" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.4.2</span> Drifting</h4>
<div class="outline-text-4" id="text-6-4-2">
<p>
The <code>IDrifter</code> components are responsible for transforming a depo at one location and time into another depo at a different location and time while suitably adjusting the number of ionization electrons and their 2D extents.  Each call of the component accepts a single depo and returns zero or more output depos.  Input depos are assumed to be strictly time ordered and each batch of output depos likewise.  In general a drifter must cache depos for some length of time in order to assure it has seen all possible depos to satisfy causality for the output.
</p>
</div>
</div>

<div id="outline-container-orgde2d9b9" class="outline-4">
<h4 id="orgde2d9b9"><a id="user-content-orgde2d9b9" class="anchor" href="#orgde2d9b9" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.4.3</span> Response</h4>
<div class="outline-text-4" id="text-6-4-3">
<p>
The field and electronics response of the detector is calculated in an <code>IDuctor</code> component.  This is typically done by accepting depos at some <i>input plane</i> or <i>response plane</i>.  Up to this plane, any drifting depo is assumed to induce a negligible detector response.  For drifting beyond this plane some position dependent  response is applied (ie, a field response calculated by 2D Garfield or 3D LARF).  Each call to an <code>IDuctor</code> components accepts one depo and produces zero or more frames (<code>IFrame</code> data object).  In general an <code>IDuctor</code> component must cache depos long enough to assure the produced frames satisfy causality.  Output frames may be sparse in that not all channels may have traces (<code>ITrace</code> data objects) and in any given channel the traces may not cover the same span of time.  The unit for the waveforms in the frame depend on the detector response applied.  If field response alone is applied then the waveform is in units of sampled current (fixme, check code, it may be integrated over tick and thus charge.)  If both field and electronics response is applied the waveform is in units of voltage.
</p>
</div>
</div>


<div id="outline-container-org72bafb8" class="outline-4">
<h4 id="org72bafb8"><a id="user-content-org72bafb8" class="anchor" href="#org72bafb8" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.4.4</span> Digitizing</h4>
<div class="outline-text-4" id="text-6-4-4">
<p>
An <code>IDigitizer</code> component applies a transformation to the waveform, typically but not necessarily in order to truncate it to ADC.  These components are functional in that each call takes and produces one frame.  Even if truncating to ADC the frame is still expressed as floating point values.
</p>
</div>
</div>

<div id="outline-container-org8b692cd" class="outline-4">
<h4 id="org8b692cd"><a id="user-content-org8b692cd" class="anchor" href="#org8b692cd" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.4.5</span> Noise</h4>
<div class="outline-text-4" id="text-6-4-5">
<p>
t.b.d.
</p>
</div>
</div>

<div id="outline-container-org21feb48" class="outline-4">
<h4 id="org21feb48"><a id="user-content-org21feb48" class="anchor" href="#org21feb48" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.4.6</span> Frame Summing</h4>
<div class="outline-text-4" id="text-6-4-6">
<p>
Right now, frames can be summed by a bare function <code>FrameUtil::sum()</code>.  This is better put into a component.
</p>
</div>
</div>

<div id="outline-container-orgcb81342" class="outline-4">
<h4 id="orgcb81342"><a id="user-content-orgcb81342" class="anchor" href="#orgcb81342" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-4">6.4.7</span> Execution Graphs</h4>
<div class="outline-text-4" id="text-6-4-7">
<p>
The <code>gen</code> package provides high-level <code>IApplication</code> components.  Primarily, these provide aggregation of the various components described above (and others).  The aggregation is conceptually of the form of a call graph which connects outputs of components to inputs of others.  This aggregation is <b>hard-coded</b> so that the application determines the connectivity of the resulting execution graph.  
</p>

<dl class="org-dl">
<dt>Fourdee</dt><dd>provides a simple linear drift simulation chain from depos to digitized frame and with noise included.  Only a single detector response is allowed and a single frame with signal and noise summed together is produced.  (Aside: the &ldquo;dee&rdquo; stands for the various components with names starting with &ldquo;D&rdquo;.)</dd>

<dt>Multidee</dt><dd>provides a drift simulation that takes depositions through multiple paths and which produce multiple semantically different frames for the same set of depositions.  The overall execution graph is shown in the figure below.  The <code>DepoFanout</code> represents sending the same depo to multiple <code>Ductor</code> components.  The <code>MultiDuctor</code> will apply particular detector response depending on where the depo is (measured in wire-space).  This can be used to emulate MicroBooNE&rsquo;s shorted wires.  A second pointer to a depo goes into the &ldquo;truth&rdquo; <code>Ductor</code> which has a set of field response functions that produce some kind of &ldquo;true&rdquo; signal waveforms from the input depositions (eg, a simple Gaussian smearing instead of bipolar/unipolar field response).  Finally, each frame is sunk for output by the <code>MultiFrameSink</code> which is just an <code>IFrameSink</code> that collates based on frame identifier numbers.</dd>
</dl>


<div class="figure">
<p><object type="image/svg+xml" data="figs/multidee.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>
</div>

<div id="outline-container-orga56cef5" class="outline-5">
<h5 id="orga56cef5"><a id="user-content-orga56cef5" class="anchor" href="#orga56cef5" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="section-number-5">6.4.7.1</span> Hard-coded vs Configurable</h5>
<div class="outline-text-5" id="text-6-4-7-1">
<p>
WCT supports construction of general execution graphs through user-provided configuration.  
</p>

<p>
t.b.d. this code needs reworking and retesting.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgca52437" class="outline-3">
<h3 id="pkg-waftools"><a id="user-content-pkg-waftools" class="anchor" href="#pkg-waftools" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgca52437"></a><span class="section-number-3">6.5</span> <code>wire-cell-waftools</code></h3>
<div class="outline-text-3" id="text-pkg-waftools">
<p>
The WCT build system is based on <a href="https://waf.io/">Waf</a>.  The parts of the build system include:
</p>

<ul class="org-ul">
<li>the <code>wcb</code> command provided by <code>wire-cell-build</code> which is a bundled version of Waf&rsquo;s <code>waf</code> command.</li>
<li>a number of Waf tools provide instructions for finding the required and optional software dependencies</li>
<li>the main <code>wscript</code> and per-package <code>wscript_build</code> files provide the high-level instructions for building WCT (ie, they are like old fashioned <code>Makefile</code> files).</li>
</ul>
</div>

<div id="outline-container-org34e156f" class="outline-4">
<h4 id="generate-wcb"><a id="user-content-generate-wcb" class="anchor" href="#generate-wcb" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org34e156f"></a><span class="section-number-4">6.5.1</span> Recreating <code>wcb</code></h4>
<div class="outline-text-4" id="text-generate-wcb">
<p>
The <code>wcb</code> command bundles some optional Waf tools which are not included in the default version of the <code>waf</code> command.  In case new versions of Waf or new tools are needed it can be recreated like this:
</p>

<pre class="example">
$ git clone https://github.com/waf-project/waf.git
$ cd waf/
$ ./waf-light --tools=compat15,doxygen,boost,bjam
$ cp waf /path/to/wire-cell-build/wcb
$ cd /path/to/wire-cell-build
$ git commit [...]
</pre>
</div>
</div>

<div id="outline-container-orga3cebbf" class="outline-4">
<h4 id="bundle-waf-tools"><a id="user-content-bundle-waf-tools" class="anchor" href="#bundle-waf-tools" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orga3cebbf"></a><span class="section-number-4">6.5.2</span> Included Waf tools</h4>
<div class="outline-text-4" id="text-bundle-waf-tools">
<p>
A number of Waf tools are provided in the <a href="https://github.com/wirecell/wire-cell-waftools">waftools</a> submodule.  This provides a Python module for each software package which is a required or optional dependency and which is not already covered by Waf itself. New dependencies can be added by using existing modules as examples.  It is the <code>smplpkgs.py</code> module which handles the building of the WCT packages themselves.  The <code>wcb.py</code> module is used as a simple aggregate of all the other modules.  It is this that is loaded by the main <code>wscript</code>.
</p>

<div class="note">
<p>
The scripts to make and test releases are also housed in this package.
</p>

</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org4aafce4" class="outline-2">
<h2 id="data-flow-programming"><a id="user-content-data-flow-programming" class="anchor" href="#data-flow-programming" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org4aafce4"></a><span class="section-number-2">7</span> Data Flow Programming</h2>
<div class="outline-text-2" id="text-data-flow-programming">
<p>
All about data flow programming support in WCT.
</p>
</div>
</div>

<div id="outline-container-org687ebcf" class="outline-2">
<h2 id="other-topics"><a id="user-content-other-topics" class="anchor" href="#other-topics" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org687ebcf"></a><span class="section-number-2">8</span> Other Topics</h2>
<div class="outline-text-2" id="text-other-topics">
</div>

<div id="outline-container-org0055b76" class="outline-3">
<h3 id="garfield-2d-support"><a id="user-content-garfield-2d-support" class="anchor" href="#garfield-2d-support" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org0055b76"></a><span class="section-number-3">8.1</span> Garfield 2D Support</h3>
<div class="outline-text-3" id="text-garfield-2d-support">
<p>
Garfield 2D is used to provide field response functions for WCT signal processing and simulation.  This section collects some documentation of this.
</p>
</div>

<div id="outline-container-orgb4138b4" class="outline-4">
<h4 id="garfield-2d-data"><a id="user-content-garfield-2d-data" class="anchor" href="#garfield-2d-data" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgb4138b4"></a><span class="section-number-4">8.1.1</span> Garfield 2D data</h4>
<div class="outline-text-4" id="text-garfield-2d-data">
<p>
Garfield 2D is used to calculate various things:
</p>

<ul class="org-ul">
<li>the electrostatic or drift field near the wire planes</li>
<li>electron drift paths through this field starting from an array of points at a (nominal) fixed drift distance and terminating on an electrode</li>
<li>the Shockley-Ramo <i>weighting field</i> for one <i>central wire</i> of each wire plane</li>
<li>the instantaneous current in each central wire separately for each drift path and regularly sampled over time.</li>
</ul>

<p>
The Garfield 2D user is free to pick the array drift path starting points however, a choice was made for initial field calculations and processing of Garfield 2D output assumes it holds.  In particular:
</p>

<ul class="org-ul">
<li>The drift paths all start with a fixed &ldquo;X&rdquo; coordinate value</li>
<li>There is one drift path exactly aligned with each wire in the transverse direction.</li>
<li>There is one drift path on one side of each wire starting exactly at the transverse midpoint with its neighbor</li>
<li>There are four more equal spaced drift paths between these two.</li>
</ul>

<p>
These paths are said to start at <i>impact positions</i>.  These impact positions extend across the entire transverse domain, bounded by one half wire pitch below the lowest wire and one half pitch above the highest wire.  The impact positions where Garfield 2D paths start represent half of the total.  The remaining half are defined through symmetry.
</p>

<div class="warning">
<p>
In the initial <code>ub_10</code> data set with 21 wires \(\times\) 6 impact positions \(\times\) 3 planes the counting of impact position numbers and wire numbers are in opposite transverse directions.  This is corrected for in the preprocessing.  If future Garfield 2D runs attempt to &ldquo;fix&rdquo; this it will break the preprocessing.
</p>

</div>
</div>
</div>

<div id="outline-container-org25f39c5" class="outline-4">
<h4 id="preprocessing-garfield-data"><a id="user-content-preprocessing-garfield-data" class="anchor" href="#preprocessing-garfield-data" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org25f39c5"></a><span class="section-number-4">8.1.2</span> Preprocessing of Garfield 2D data</h4>
<div class="outline-text-4" id="text-preprocessing-garfield-data">
<p>
WCT provides a Python module to assist in generating a WCT field response file in compressed JSON format.  It also is responsible for filling in missing drift paths, correcting any vagaries, normalizing units.
</p>

<div class="info">
<p>
The output field response functions must be given in the form of a sampled, electric current waveform due to the passage of a <b>single electron</b> along the drift path and the current must be expressed in the WCT system of units for electric current.  The response function is <b>not</b> in units of electric charge.  
</p>

</div>

<p>
The main entry point into the Garfield 2D support is:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> wirecell.sigproc.garfield <span style="font-weight: bold;">as</span> garfield
</pre>
</div>

<p>
The next section gives some detailed examples of use and subsequent ones give some plots.
</p>
</div>
</div>

<div id="outline-container-org390682a" class="outline-4">
<h4 id="eyeball-garfield"><a id="user-content-eyeball-garfield" class="anchor" href="#eyeball-garfield" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org390682a"></a><span class="section-number-4">8.1.3</span> Eyeballing Garfield 2D with <code>wirecell.sigproc.garfield</code></h4>
<div class="outline-text-4" id="text-eyeball-garfield">
<p>
This is from the <code>ub_10</code> data set.
</p>

<p>
Taking raw Garfield output shows, apparently, two electrons were drifted per path.  It&rsquo;s unclear why it&rsquo;s slightly more than 2.0 electrons of charge though.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> wirecell.sigproc.garfield <span style="font-weight: bold;">as</span> garfield
dat = garfield.load(<span style="font-style: italic;">"/opt/bviren/wct-dev/share/wirecell/data/ub_10.tar.gz"</span>)
w = [r <span style="font-weight: bold;">for</span> r <span style="font-weight: bold;">in</span> dat <span style="font-weight: bold;">if</span> r.impact == 0 <span style="font-weight: bold;">and</span> r.region == 0 <span style="font-weight: bold;">and</span> r.plane == <span style="font-style: italic;">'w'</span>][0]
<span style="font-weight: bold;">sum</span>(w.response)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; -0.020265450377670812</span>
w.times[1] / units.us
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; 0.1</span>
<span style="font-weight: bold;">sum</span>(w.response) * w.times[1] / units.coulomb
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; -3.2468828093569448e-19</span>
<span style="font-weight: bold;">sum</span>(w.response) * w.times[1] / units.eplus
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; -2.0265450377670811</span>
w0 = [r <span style="font-weight: bold;">for</span> r <span style="font-weight: bold;">in</span> dat <span style="font-weight: bold;">if</span> r.region == 0 <span style="font-weight: bold;">and</span> r.plane == <span style="font-style: italic;">'w'</span>]
<span style="font-weight: bold;">len</span>(w0)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; 6</span>
w0[0].region
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; 0</span>
<span style="font-weight: bold;">sum</span>(w0[0].response)/units.microampere
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; -3.2577267395296085e-06</span>
[<span style="font-weight: bold;">sum</span>(w.response)*w.times[1]/units.eplus <span style="font-weight: bold;">for</span> w <span style="font-weight: bold;">in</span> w0]
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; [-2.033313287245619,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">-2.0184390655262097,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">-2.061704680164814,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">-2.057934020579546,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">-2.0501410482117408,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">-2.0265450377670811]</span>
</pre>
</div>

<p>
Modify <code>garfield.load()</code> to normalize all responses so that this last array averages to 1.0.  After that change:
</p>

<div class="org-src-container">
<pre class="src src-python">[<span style="font-weight: bold;">sum</span>(r.response)*r.times[1]/units.eplus <span style="font-weight: bold;">for</span> r <span style="font-weight: bold;">in</span> dat2 <span style="font-weight: bold;">if</span> r.region == 0 <span style="font-weight: bold;">and</span> r.plane == <span style="font-style: italic;">'w'</span>]
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; [0.99606489937379161,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">0.98877842254157267,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">1.0099730708830847,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">1.0081259272658833,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">1.0043083619718129,</span>
<span style="font-weight: bold; font-style: italic;">#     </span><span style="font-weight: bold; font-style: italic;">0.99274931796385024]</span>
<span style="font-weight: bold;">sum</span>([<span style="font-weight: bold;">sum</span>(r.response)*r.times[1]/units.eplus <span style="font-weight: bold;">for</span> r <span style="font-weight: bold;">in</span> dat2 <span style="font-weight: bold;">if</span> r.region == 0 <span style="font-weight: bold;">and</span> r.plane == <span style="font-style: italic;">'w'</span>])/6.0
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">-&gt; 0.99999999999999944</span>
</pre>
</div>

<p>
Same region 0 average in units of <code>eplus</code> for U is -6.9e-3  and for V is -5.5e-3.
</p>
</div>
</div>

<div id="outline-container-org88e8883" class="outline-4">
<h4 id="garfield-validation-plots"><a id="user-content-garfield-validation-plots" class="anchor" href="#garfield-validation-plots" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org88e8883"></a><span class="section-number-4">8.1.4</span> Validation plots</h4>
<div class="outline-text-4" id="text-garfield-validation-plots">
<p>
Some critical validation plots can be made from the command line using the <code>wirecell-sigproc</code> program.  In the examples below it is assumed, for brevity that the Garfield 2D data set is available via the <code>$G2D</code> environment variable set for example like:
</p>

<pre class="example">
$ export G2D=/opt/bviren/wct-dev/share/wirecell/data/ub_10.tar.gz
</pre>
</div>

<div id="outline-container-org74aae7b" class="outline-5">
<h5 id="garfield-isochronous-track"><a id="user-content-garfield-isochronous-track" class="anchor" href="#garfield-isochronous-track" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org74aae7b"></a><span class="section-number-5">8.1.4.1</span> Perpendicular ideal track</h5>
<div class="outline-text-5" id="text-garfield-isochronous-track">
<p>
A perpendicular ideal track can be &ldquo;simulated&rdquo; by summing response functions.  This is because the response on neighboring wires due to a charge drifting near the central wire is equivalent to the response on the central wire due to charge drifting near neighboring wires.  
</p>

<p>
There are three main data tiers:
</p>

<ol class="org-ol">
<li>instantaneous induced current</li>
<li>sampled voltage after preamplifier gain and shaping done in the FEE</li>
<li>digitized ADC waveform of that voltage</li>
</ol>

<p>
This command can be used to make plots of these with different parameterizations:
</p>

<pre class="example">
$ wirecell-sigproc plot-garfield-track-response --help
Usage: wirecell-sigproc plot-garfield-track-response [OPTIONS]
                                                     GARFIELD_FILESET PDFFILE

  Plot Garfield response assuming a perpendicular track.

Options:
  -o, --output TEXT         Set output data file
  -g, --gain FLOAT          Set gain in mV/fC.
  -s, --shaping FLOAT       Set shaping time in us.
  -t, --tick FLOAT          Set tick time in us (0.1 is good for no shaping).
  -n, --norm INTEGER        Set normalization in units of electron charge.
  -a, --adc-gain FLOAT      Set ADC gain (unitless).
  --adc-voltage FLOAT       Set ADC voltage range in Volt.
  --adc-resolution INTEGER  Set ADC resolution in bits.
  --help                    Show this message and exit.
</pre>

<p>
If the shaping is zero, then the induced current is plotted.  If it is nonzero but the ADC gain is zero then pre-ADC voltages are plotted.  If both are nonzero (default) then the ADC waveforms are plotted
</p>
</div>
</div>

<div id="outline-container-orgb4fcf28" class="outline-5">
<h5 id="garfield-induced-current"><a id="user-content-garfield-induced-current" class="anchor" href="#garfield-induced-current" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orgb4fcf28"></a><span class="section-number-5">8.1.4.2</span> Induced current</h5>
<div class="outline-text-5" id="text-garfield-induced-current">
<p>
Garfield 2D provides instantaneous, sampled induced current waveforms.  Their per-plane sum, as described above equivalent to a perpendicular track, can be plotted with zero shaping time:
</p>

<pre class="example">
$ wirecell-sigproc plot-garfield-track-response -s 0.0 $G2D figs/track-response-current.svg
</pre>


<div class="figure">
<p><object type="image/svg+xml" data="figs/track-response-current.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>

<div class="info">
<p>
The default normalization is such that there are 16000 electrons per pitch (MIP) and no diffusion.  Just doing the unit conversions, this many electrons arriving over 2-3 us should give a current of about a nanoamp.
</p>

</div>
</div>
</div>

<div id="outline-container-org7a5c0ea" class="outline-5">
<h5 id="garvield-amplified-voltage"><a id="user-content-garvield-amplified-voltage" class="anchor" href="#garvield-amplified-voltage" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org7a5c0ea"></a><span class="section-number-5">8.1.4.3</span> Amplified Voltage</h5>
<div class="outline-text-5" id="text-garvield-amplified-voltage">
<p>
The results of convolution with electronics response can be plotted with a zero per-ADC gain:
</p>

<pre class="example">
$ wirecell-sigproc plot-garfield-track-response -a 0.0 $G2D figs/track-response-voltage.svg
</pre>


<div class="figure">
<p><object type="image/svg+xml" data="figs/track-response-voltage.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>

<div class="info">
<p>
The default preamplifier gain is 14 mV/fC.  This means that a delta-function current integrating to 1 fC would produce a smooth voltage curve with a <b>peak</b> of 14 mV.  The default 16000 electrons per pitch, if producing a delta-function of current, would produce 36 mV.  Because of broadening and finite width as shown in the previous plot, this peak should be reduced and smeared.
</p>

</div>
</div>
</div>

<div id="outline-container-org359f017" class="outline-5">
<h5 id="garfield-adc-waveform"><a id="user-content-garfield-adc-waveform" class="anchor" href="#garfield-adc-waveform" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="org359f017"></a><span class="section-number-5">8.1.4.4</span> Digitized ADC Waveform</h5>
<div class="outline-text-5" id="text-garfield-adc-waveform">
<p>
Finally, the expected ADC output is plotted by default.
</p>

<pre class="example">
$ wirecell-sigproc plot-garfield-track-response $G2D figs/track-response-adc.svg
</pre>


<div class="figure">
<p><object type="image/svg+xml" data="figs/track-response-adc.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>

<div class="info">
<p>
This assumes the default 12 bit ADC spanning 2 volts.
</p>

</div>
</div>
</div>
</div>

<div id="outline-container-orga5298cc" class="outline-4">
<h4 id="convert-garfield-data-to-json"><a id="user-content-convert-garfield-data-to-json" class="anchor" href="#convert-garfield-data-to-json" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a id="orga5298cc"></a><span class="section-number-4">8.1.5</span> Producing WCT Field Response Data File</h4>
<div class="outline-text-4" id="text-convert-garfield-data-to-json">
<p>
The WCT does not directly read Garfield 2D data sets but instead requires the information to be compiled into a single, compressed JSON file.  This is done like:
</p>

<pre class="example">
$ wirecell-sigproc convert-garfield $G2D garfield-1d-3planes-21wires-6impacts-v5.json.bz2
</pre>

<p>
FIXME: distribution of these data files needs some formal mechanism.  For now, they may be available here: <a href="http://www.phy.bnl.gov/~bviren/tmp/wctsim/wct-dev/share/wirecell/data/">http://www.phy.bnl.gov/~bviren/tmp/wctsim/wct-dev/share/wirecell/data/</a>.
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Brett Viren</p>
<p class="date">Created: 2017-07-03 Mon 17:12</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
